# US-029: Project Manager Dependency - Code Developer Must Push to Roadmap Frequently

**Status**: üö® Critical
**Priority**: **CRITICAL** (Blocking project_manager workflow)
**Estimate**: 2-3 hours
**Blocks**: All project_manager visibility and coordination
**Implements**: US-024 (from project_manager perspective)

## User Story
As a **project_manager**,
I **NEED** to be sure I have gathered all commits from code_developer,
So I **rely on code_developer pushing frequently to roadmap branch** with all changes (including ROADMAP.md updates).

## Critical Problem

**Current Situation** (BLOCKING):
```
‚ùå project_manager on roadmap branch:
   - Sees outdated ROADMAP.md
   - Doesn't know what code_developer is working on
   - Can't provide timely feedback
   - Doesn't know if daemon is stuck or making progress

‚ùå code_developer on feature branch:
   - Makes commits (new tickets, ROADMAP updates, code changes)
   - Does NOT push to roadmap
   - Progress is invisible to project_manager
   - Only visible after final PR merge
```

**Impact on Project Manager**:
- üö® **Cannot track progress** - No visibility into what's being worked on
- üö® **Cannot provide feedback** - By the time I see work, it's too late to course-correct
- üö® **Cannot coordinate** - Don't know if daemon needs my input
- üö® **Cannot trust roadmap branch** - Stale data makes it useless as source of truth
- üö® **Wasted time** - Daemon might work on wrong priorities for hours before I notice

## What Project Manager NEEDS

As project_manager, I need code_developer to:

### 1. Push to Roadmap After Every Logical Unit of Work
```bash
# After completing a sub-task
git checkout roadmap
git merge --no-ff feature-branch -m "Merge: Completed ConfigManager migration"
git push origin roadmap
git checkout feature-branch

# After updating ROADMAP.md
git checkout roadmap
git merge --no-ff feature-branch -m "Merge: Updated ROADMAP progress"
git push origin roadmap
git checkout feature-branch

# After creating new tickets
git checkout roadmap
git merge --no-ff feature-branch -m "Merge: Created US-029 ticket"
git push origin roadmap
git checkout feature-branch
```

### 2. Push Before Going Idle/Sleep
```bash
# Before sleep interval (every 30 seconds)
git checkout roadmap
git merge --no-ff feature-branch -m "Merge: End of iteration checkpoint"
git push origin roadmap
git checkout feature-branch
time.sleep(30)
```

### 3. Push Immediately After ROADMAP.md Changes
This is **CRITICAL** because project_manager relies on ROADMAP.md on the roadmap branch to know:
- What's currently being worked on
- What's planned next
- What's completed
- What's blocked

If ROADMAP.md updates aren't pushed to roadmap immediately, project_manager is looking at **stale priorities**.

## Required Implementation

### Critical: `_merge_to_roadmap()` Method

Add to `coffee_maker/autonomous/daemon.py`:

```python
def _merge_to_roadmap(self, message: str = "Sync progress to roadmap") -> bool:
    """Merge current feature branch to roadmap branch.

    CRITICAL: project_manager DEPENDS on this for visibility!

    This method ensures project_manager can see all progress in real-time
    by frequently merging feature branch changes to the roadmap branch.

    Called after:
    - Completing any sub-task
    - Updating ROADMAP.md (CRITICAL!)
    - Creating new tickets
    - Before sleep/idle

    Args:
        message: Description of what was accomplished

    Returns:
        True if merge successful, False if conflicts

    Example:
        >>> # After updating ROADMAP.md
        >>> self._merge_to_roadmap("Updated US-021 progress")
        True

        >>> # Before sleep
        >>> self._merge_to_roadmap("End of iteration checkpoint")
        True
    """
    try:
        import subprocess

        # Get current branch
        current_branch = subprocess.check_output(
            ["git", "branch", "--show-current"],
            text=True
        ).strip()

        if current_branch == "roadmap":
            logger.warning("Already on roadmap branch, skipping merge")
            return True

        # Commit any uncommitted changes
        status = subprocess.check_output(
            ["git", "status", "--porcelain"],
            text=True
        )

        if status.strip():
            subprocess.run(["git", "add", "-A"], check=True)
            subprocess.run(["git", "commit", "-m", message], check=True)
            subprocess.run(["git", "push", "origin", current_branch], check=True)

        # Switch to roadmap
        subprocess.run(["git", "checkout", "roadmap"], check=True)
        subprocess.run(["git", "pull", "origin", "roadmap"], check=True)

        # Merge with --no-ff (preserves history)
        merge_result = subprocess.run(
            ["git", "merge", "--no-ff", "-m",
             f"Merge {current_branch}: {message}", current_branch],
            capture_output=True,
            text=True
        )

        if merge_result.returncode != 0:
            # CONFLICT - abort and notify project_manager
            subprocess.run(["git", "merge", "--abort"], check=True)
            subprocess.run(["git", "checkout", current_branch], check=True)

            # Create CRITICAL notification for project_manager
            self.notifications.create_notification(
                type="error",
                priority="critical",
                title=f"üö® MERGE CONFLICT: {current_branch} ‚Üí roadmap",
                message=f"""Automatic merge to roadmap failed with conflicts.

‚ö†Ô∏è  PROJECT_MANAGER VISIBILITY BLOCKED!

The roadmap branch is now out of sync with {current_branch}.
Manual intervention required to restore visibility.

Steps to resolve:
1. git checkout roadmap
2. git pull origin roadmap
3. git merge {current_branch}
4. Resolve conflicts in affected files
5. git add <resolved-files>
6. git commit
7. git push origin roadmap

Until resolved, project_manager cannot see latest progress.
"""
            )

            logger.error(f"Merge conflict: {current_branch} ‚Üí roadmap")
            logger.error("PROJECT_MANAGER VISIBILITY BLOCKED!")
            return False

        # Push to origin/roadmap
        subprocess.run(["git", "push", "origin", "roadmap"], check=True)

        # Switch back to feature branch
        subprocess.run(["git", "checkout", current_branch], check=True)

        logger.info(f"‚úÖ Merged {current_branch} ‚Üí roadmap")
        logger.info(f"‚úÖ project_manager can now see: {message}")
        return True

    except Exception as e:
        logger.error(f"Failed to merge to roadmap: {e}")
        logger.error("PROJECT_MANAGER CANNOT SEE PROGRESS!")

        # Try to recover
        try:
            subprocess.run(["git", "checkout", current_branch], check=True)
        except:
            pass

        return False
```

### Integration Points (WHERE to call `_merge_to_roadmap()`)

#### 1. **CRITICAL: After Any ROADMAP.md Update**
```python
# In run() loop - after implementing priority
def run(self):
    while self.running:
        # ... implement priority ...

        # Check if ROADMAP.md was modified
        if self._roadmap_was_updated():
            # IMMEDIATELY merge to roadmap so project_manager sees update
            self._merge_to_roadmap(f"Updated ROADMAP.md for {priority['name']}")
```

#### 2. After Creating Tickets
```python
def _create_user_story(self, ticket_path):
    # ... create ticket file ...

    # Commit to feature branch
    self.git.commit(f"docs: Create {os.path.basename(ticket_path)}")

    # Merge to roadmap so project_manager sees new ticket
    self._merge_to_roadmap(f"Created {os.path.basename(ticket_path)}")
```

#### 3. Before Sleep/Idle (End of Iteration)
```python
def run(self):
    while self.running:
        # ... iteration work ...

        # Before sleep, merge progress to roadmap
        self._merge_to_roadmap("End of iteration checkpoint")

        logger.info(f"üí§ Sleeping {self.sleep_interval}s")
        time.sleep(self.sleep_interval)
```

#### 4. After Completing Sub-tasks
```python
def _implement_priority(self, priority):
    # ... implementation ...

    # After Claude API completes and files are committed
    if self.git.commit(commit_message):
        # Merge to roadmap so project_manager sees progress
        self._merge_to_roadmap(f"Completed work on {priority['name']}")
```

## Acceptance Criteria

### MUST HAVE (Critical for project_manager)
- [x] `_merge_to_roadmap()` method implemented in daemon.py
- [ ] **CRITICAL**: Daemon merges to roadmap IMMEDIATELY after ANY ROADMAP.md update
- [ ] Daemon merges to roadmap after creating tickets
- [ ] Daemon merges to roadmap before sleep/idle
- [ ] Daemon merges to roadmap after completing implementation work
- [ ] Conflicts detected and project_manager notified with CRITICAL priority
- [ ] Feature branch preserved (checkout back after merge)
- [ ] All merges use `--no-ff` flag (preserves history)

### Should Have
- [ ] Configurable merge frequency (env var or config)
- [ ] Skip merge if no changes since last merge
- [ ] Notification on successful merge (low priority)
- [ ] Merge statistics tracked

### Nice to Have
- [ ] Auto-resolve simple ROADMAP.md conflicts
- [ ] Merge queue for batching
- [ ] Dashboard showing last merge timestamp

## Why This is CRITICAL

### Project Manager Workflow Dependency

```
WITHOUT frequent merges:
  project_manager              code_developer
        ‚Üì                            ‚Üì
   [Views roadmap] ‚îÄ‚îÄ‚îê          [Works on feature]
        ‚Üì            ‚îÇ               ‚Üì
   Sees stale       ‚îÇ          [Updates ROADMAP]
   priorities       ‚îÇ               ‚Üì
        ‚Üì            ‚îÇ          [Creates tickets]
   Provides         ‚îÇ               ‚Üì
   feedback on      ‚îÇ          [Makes progress]
   WRONG work!      ‚îÇ               ‚Üì
        ‚Üì            ‚îÇ          [Sleeps...]
   Wasted time      ‚îÇ               ‚Üì
        ‚Üì            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[Eventually merges]
   Finally sees                     ‚Üì
   actual work                 Too late to
   (too late!)                 course-correct!


WITH frequent merges:
  project_manager              code_developer
        ‚Üì                            ‚Üì
   [Views roadmap] ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       [Works on feature]
        ‚Üì               ‚îÇ            ‚Üì
   Sees current         ‚îÇ       [Updates ROADMAP]
   priorities           ‚îÇ            ‚Üì
        ‚Üì               ‚îî‚îÄ‚îÄ‚îÄ[IMMEDIATE MERGE]
   Provides                         ‚Üì
   timely               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ[Creates tickets]
   feedback             ‚îÇ            ‚Üì
        ‚Üì               ‚îî‚îÄ‚îÄ‚îÄ[IMMEDIATE MERGE]
   Course correction                ‚Üì
   while work                  [Makes progress]
   is in progress!                  ‚Üì
                           [MERGE before sleep]
```

## Testing Plan

### Manual Testing by Project Manager
```bash
# 1. Start on roadmap branch
git checkout roadmap
git pull origin roadmap

# 2. Note current ROADMAP.md state
cat docs/ROADMAP.md | head -50

# 3. Start daemon (in another terminal)
poetry run code-developer

# 4. Watch roadmap branch for updates
watch -n 5 'git pull origin roadmap && git log --oneline -5'

# Expected: See frequent merge commits like:
# - "Merge feature/xxx: Updated ROADMAP.md for US-029"
# - "Merge feature/xxx: Created US-030 ticket"
# - "Merge feature/xxx: End of iteration checkpoint"

# 5. Verify I can see ROADMAP.md updates in real-time
cat docs/ROADMAP.md | head -50
# Should show daemon's latest updates, not stale version
```

### Validation Checklist
- [ ] Roadmap branch updates within 30 seconds of daemon making changes
- [ ] ROADMAP.md on roadmap branch is always current (not stale)
- [ ] New tickets visible on roadmap branch immediately after creation
- [ ] Merge conflicts handled gracefully (notification sent)
- [ ] Feature branch still intact after merge
- [ ] Git history shows clear merge commits with descriptive messages

## Success Metrics

**After Implementation:**
- ‚úÖ project_manager can see **100%** of daemon's work within 30 seconds
- ‚úÖ ROADMAP.md on roadmap branch is **never more than 30 seconds stale**
- ‚úÖ New tickets visible on roadmap branch **immediately** after creation
- ‚úÖ Merge conflict rate < 5%
- ‚úÖ project_manager satisfaction: "I can finally see what's happening!"

## Related Tickets
- **US-024**: Frequent Roadmap Branch Synchronization (this implements it)
- **US-027**: Roadmap Branch as Single Source of Truth (depends on this)
- **US-028**: Workflow Documentation in PyDoc (documents this workflow)
- **BUG-002**: Daemon Roadmap Synchronization (original bug this fixes)

## Implementation Priority

**WHY CRITICAL:**
1. **Blocks project_manager workflow** - Can't see progress without this
2. **Wastes daemon time** - Works on wrong priorities due to stale ROADMAP.md
3. **Prevents coordination** - Can't provide timely feedback
4. **Breaks US-027** - "Single source of truth" is meaningless if it's stale

**MUST BE IMPLEMENTED BEFORE:**
- Any other new features
- Any other user stories
- Daemon can work autonomously for extended periods

This is the **foundation** of the visibility loop. Without it, the entire workflow breaks down.

---

ü§ñ **Created**: 2025-10-11 by project_manager (critical requirement)
**Estimated Implementation Time**: 2-3 hours
**Priority**: üö® **CRITICAL** - Blocking all project_manager visibility
**Assigned To**: code_developer daemon
**Due**: ASAP - This is the #1 blocker for project_manager workflow
