# US-026: Automatic Bug Issue Creation from PR Comments

**Status**: üìù Planned
**Priority**: Medium
**Estimate**: 4-6 hours

## User Story
As a **user**,
I want to **comment on a pull request to report a problem**,
So that **a bug issue is automatically created** and tracked properly.

## Problem
Currently, when reviewing a PR and finding a problem:
- ‚ùå User must manually create a bug ticket
- ‚ùå Must switch context from PR review to issue creation
- ‚ùå Risk of forgetting to document the bug
- ‚ùå No automatic linking between PR comment and bug issue
- ‚ùå Developer may miss the bug report in PR comments

**Impact**:
- Bugs get lost in PR comments
- Poor tracking of issues found during review
- Slower bug resolution
- Inconsistent bug reporting process

## Proposed Solution
Implement automatic bug issue creation triggered by PR comments with specific markers:

### Triggering Bug Creation

**Option 1: Magic Comment Syntax**
```markdown
üêõ Bug: Authentication fails when password contains special characters

**Steps to Reproduce**:
1. Enter password with `&` character
2. Click login
3. Error: Invalid credentials

**Expected**: Login should work with any valid password
**Actual**: Login fails
```

**Option 2: Comment Label/Tag**
```markdown
@bugbot create issue

Authentication fails when password contains special characters...
```

**Option 3: PR Review "Request Changes" with Bug Marker**
- When reviewer requests changes with comment containing `üêõ` or `Bug:`
- Automatically creates bug issue

---

## Technical Implementation

### Architecture

```
PR Comment ‚Üí GitHub Webhook ‚Üí Lambda/Cloud Function ‚Üí Create Bug Issue
                                                     ‚Üì
                                            Link to PR Comment
                                                     ‚Üì
                                            Notify Developer
```

### Components

1. **GitHub Webhook Handler**
   - Listens for PR review comments
   - Filters for bug markers (üêõ, `Bug:`, `@bugbot`)
   - Extracts bug details from comment

2. **Bug Issue Creator**
   - Creates ticket in `tickets/BUG-XXX.md`
   - Populates from comment content
   - Links back to PR comment
   - Assigns to PR author (or custom assignee)

3. **Notification System**
   - Notifies developer via project-manager
   - Adds comment to PR: "Bug issue created: BUG-XXX"
   - Updates bug ticket with PR reference

### Implementation Options

#### Option A: GitHub Actions Workflow (Recommended)

**File**: `.github/workflows/pr-comment-to-bug.yml`

```yaml
name: PR Comment to Bug Issue

on:
  pull_request_review_comment:
    types: [created]
  issue_comment:
    types: [created]

jobs:
  create-bug-issue:
    runs-on: ubuntu-latest
    if: contains(github.event.comment.body, 'üêõ') || contains(github.event.comment.body, 'Bug:')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Extract bug details
        id: extract
        run: |
          python scripts/extract_bug_from_comment.py \
            --comment "${{ github.event.comment.body }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --comment-url "${{ github.event.comment.html_url }}" \
            --author "${{ github.event.comment.user.login }}"

      - name: Create bug ticket
        run: |
          python scripts/create_bug_from_comment.py \
            --title "${{ steps.extract.outputs.title }}" \
            --description "${{ steps.extract.outputs.description }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --comment-url "${{ github.event.comment.html_url }}" \
            --reporter "${{ github.event.comment.user.login }}"

      - name: Commit bug ticket
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tickets/BUG-*.md
          git commit -m "bug: Create bug issue from PR #${{ github.event.pull_request.number }} comment"
          git push

      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const bugNumber = '${{ steps.extract.outputs.bug_number }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚úÖ Bug issue created: [BUG-${bugNumber}](../blob/roadmap/tickets/BUG-${bugNumber}.md)\n\nReviewer: @${{ github.event.comment.user.login }}`
            });
```

#### Option B: Project-Manager Command

**Command**: `project-manager create-bug-from-pr <pr-number> <comment-id>`

```bash
# User reviews PR and finds bug in comment
# Then runs:
project-manager create-bug-from-pr 123 comment-456

# Automatically:
# 1. Fetches comment content
# 2. Extracts bug details
# 3. Creates BUG-XXX.md
# 4. Commits to roadmap branch
# 5. Links PR and bug issue
```

---

## Bug Ticket Format

**File**: `tickets/BUG-XXX.md`

```markdown
# BUG-XXX: <Bug Title>

**Status**: üìã Open
**Priority**: <High/Medium/Low>
**Reported By**: @<github-username>
**Found In**: PR #<number>
**Comment**: <link to PR comment>
**Date Reported**: <timestamp>

---

## Problem Description

<Extracted from PR comment>

---

## Steps to Reproduce

<Extracted from PR comment if provided>

---

## Expected Behavior

<Extracted from PR comment if provided>

---

## Actual Behavior

<Extracted from PR comment if provided>

---

## Context

**Pull Request**: #<number> - <PR title>
**Branch**: `<branch-name>`
**Files Affected**: <list from PR>
**Reporter Comment**: <full comment text>
**Comment URL**: <direct link>

---

## Proposed Fix

<Auto-generated or left blank for developer>

---

## Related Issues

- PR #<number>
- Related to: <other bugs if detected>

---

## Developer Notes

<Space for developer to add investigation notes>

---

## Resolution

**Fixed In**: <PR number>
**Fixed By**: @<developer>
**Resolution Date**: <timestamp>
**Resolution Notes**: <description of fix>

---

ü§ñ **Auto-generated** from PR review comment by @<reviewer>
**Created**: <timestamp>
```

---

## Example Workflow

### Scenario: User reviews US-021 PR and finds a bug

1. **User reviews PR #123** (US-021 Phase 1)

2. **User finds issue** - ConfigManager doesn't handle empty API keys gracefully

3. **User adds PR comment**:
```markdown
üêõ Bug: ConfigManager crashes on empty API key

**Steps to Reproduce**:
1. Set `ANTHROPIC_API_KEY=""` in .env
2. Run `poetry run code-developer`
3. Crash: TypeError: expected string, got None

**Expected**: Should raise APIKeyMissingError with helpful message
**Actual**: Crashes with TypeError

**File**: coffee_maker/config/manager.py:45
```

4. **GitHub Action triggers**:
   - Detects `üêõ` marker in comment
   - Extracts bug details
   - Creates `tickets/BUG-003.md`
   - Commits to roadmap branch
   - Comments on PR: "‚úÖ Bug issue created: BUG-003"

5. **Developer gets notified**:
   - project-manager shows new notification
   - Bug linked to PR for context

6. **Developer fixes bug**:
   - Creates fix in PR or separate branch
   - References "Fixes BUG-003" in commit
   - Updates bug ticket status

---

## Scripts to Create

### 1. `scripts/extract_bug_from_comment.py`

```python
#!/usr/bin/env python3
"""Extract bug details from PR comment."""

import argparse
import re
import sys

def extract_bug_details(comment_text: str, pr_number: int, comment_url: str, author: str):
    """Extract structured bug information from comment text.

    Looks for:
    - Bug title (after üêõ or Bug:)
    - Steps to reproduce
    - Expected/Actual behavior
    - File references
    """

    # Extract title (first line after marker)
    title_match = re.search(r'üêõ\s*(?:Bug:)?\s*(.+)', comment_text, re.IGNORECASE)
    if not title_match:
        title = "Bug reported in PR comment"
    else:
        title = title_match.group(1).strip()

    # Extract sections
    description = comment_text
    steps = extract_section(comment_text, r'\*\*Steps to Reproduce\*\*:\s*(.+?)(?=\*\*|$)', re.DOTALL)
    expected = extract_section(comment_text, r'\*\*Expected\*\*:\s*(.+?)(?=\*\*|$)')
    actual = extract_section(comment_text, r'\*\*Actual\*\*:\s*(.+?)(?=\*\*|$)')
    file_ref = extract_section(comment_text, r'\*\*File\*\*:\s*(.+?)(?=\n|$)')

    # Generate bug number (find next available)
    bug_number = get_next_bug_number()

    # Output for GitHub Actions
    print(f"::set-output name=title::{title}")
    print(f"::set-output name=description::{description}")
    print(f"::set-output name=bug_number::{bug_number}")
    print(f"::set-output name=steps::{steps}")
    print(f"::set-output name=expected::{expected}")
    print(f"::set-output name=actual::{actual}")
    print(f"::set-output name=file::{file_ref}")

def extract_section(text: str, pattern: str, flags=0) -> str:
    """Extract a section from text using regex pattern."""
    match = re.search(pattern, text, flags)
    return match.group(1).strip() if match else ""

def get_next_bug_number() -> int:
    """Find next available BUG-XXX number."""
    import glob
    existing = glob.glob("tickets/BUG-*.md")
    if not existing:
        return 1
    numbers = [int(re.search(r'BUG-(\d+)', f).group(1)) for f in existing]
    return max(numbers) + 1

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Extract bug from PR comment")
    parser.add_argument("--comment", required=True, help="Comment text")
    parser.add_argument("--pr-number", required=True, type=int, help="PR number")
    parser.add_argument("--comment-url", required=True, help="Comment URL")
    parser.add_argument("--author", required=True, help="Comment author")

    args = parser.parse_args()
    extract_bug_details(args.comment, args.pr_number, args.comment_url, args.author)
```

### 2. `scripts/create_bug_from_comment.py`

```python
#!/usr/bin/env python3
"""Create bug ticket file from extracted details."""

import argparse
from datetime import datetime
from pathlib import Path

def create_bug_ticket(
    bug_number: int,
    title: str,
    description: str,
    pr_number: int,
    comment_url: str,
    reporter: str,
    steps: str = "",
    expected: str = "",
    actual: str = "",
    file_ref: str = ""
):
    """Create BUG-XXX.md file with extracted details."""

    timestamp = datetime.now().isoformat()

    content = f"""# BUG-{bug_number:03d}: {title}

**Status**: üìã Open
**Priority**: Medium
**Reported By**: @{reporter}
**Found In**: PR #{pr_number}
**Comment**: [View Comment]({comment_url})
**Date Reported**: {timestamp}

---

## Problem Description

{description}

---

## Steps to Reproduce

{steps if steps else "_Not provided_"}

---

## Expected Behavior

{expected if expected else "_Not provided_"}

---

## Actual Behavior

{actual if actual else "_Not provided_"}

---

## Context

**Pull Request**: #{pr_number}
**Files Affected**: {file_ref if file_ref else "_Not specified_"}
**Reporter Comment**: [View original comment]({comment_url})

---

## Proposed Fix

_To be determined by developer_

---

## Related Issues

- PR #{pr_number}

---

## Developer Notes

_Add investigation notes here_

---

## Resolution

**Status**: Not fixed yet

---

ü§ñ **Auto-generated** from PR review comment by @{reporter}
**Created**: {timestamp}
"""

    # Write ticket file
    ticket_path = Path(f"tickets/BUG-{bug_number:03d}.md")
    ticket_path.write_text(content)
    print(f"‚úÖ Created bug ticket: {ticket_path}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Create bug ticket from details")
    parser.add_argument("--bug-number", required=True, type=int)
    parser.add_argument("--title", required=True)
    parser.add_argument("--description", required=True)
    parser.add_argument("--pr-number", required=True, type=int)
    parser.add_argument("--comment-url", required=True)
    parser.add_argument("--reporter", required=True)
    parser.add_argument("--steps", default="")
    parser.add_argument("--expected", default="")
    parser.add_argument("--actual", default="")
    parser.add_argument("--file", default="", dest="file_ref")

    args = parser.parse_args()
    create_bug_ticket(
        args.bug_number, args.title, args.description,
        args.pr_number, args.comment_url, args.reporter,
        args.steps, args.expected, args.actual, args.file_ref
    )
```

---

## Acceptance Criteria

### Must Have
- [ ] PR comments with üêõ marker trigger bug creation
- [ ] Bug ticket created in `tickets/BUG-XXX.md` format
- [ ] Bug ticket contains all extracted details
- [ ] PR comment linked in bug ticket
- [ ] Bug ticket linked in PR comment
- [ ] Works for both PR review comments and issue comments

### Should Have
- [ ] Extracts structured sections (Steps, Expected, Actual)
- [ ] Auto-assigns bug to PR author
- [ ] Notifies developer via project-manager
- [ ] Handles multiple bugs in same PR
- [ ] Updates ROADMAP.md with new bug

### Nice to Have
- [ ] AI-powered bug detail extraction (use LLM to parse freeform comments)
- [ ] Suggested priority based on comment keywords
- [ ] Auto-link to related bugs/issues
- [ ] Screenshot/attachment support
- [ ] Bug severity auto-detection

---

## Benefits

### For Users
- ‚úÖ **Easier Reporting**: Comment on PR, bug created automatically
- ‚úÖ **Better Tracking**: Bugs don't get lost in PR comments
- ‚úÖ **Clear Process**: Standard format for bug reports
- ‚úÖ **Faster Response**: Developer notified immediately

### For Developers
- ‚úÖ **Organized**: All bugs in `tickets/` directory
- ‚úÖ **Context**: Bug linked to PR for full context
- ‚úÖ **Prioritization**: Can triage bugs systematically
- ‚úÖ **Accountability**: Clear ownership and tracking

---

## Security Considerations

1. **Input Validation**
   - Sanitize comment text before creating ticket
   - Prevent command injection in filenames
   - Validate PR numbers and URLs

2. **Access Control**
   - Only authorized users can trigger bug creation
   - Rate limit to prevent spam
   - Log all bug creation events

3. **Data Privacy**
   - Don't expose sensitive data in bug tickets
   - Mask API keys/credentials in comments
   - Redact PII if present

---

## Success Metrics

After implementation:
- 100% of bugs found in PR review are tracked
- Bug creation time reduced from 5 minutes to <30 seconds
- 0% of bugs lost in PR comments
- User satisfaction with bug reporting improved

---

## Related User Stories
- US-025: PR Demo Files (helps users test and find bugs)
- BUG-002: Daemon roadmap sync (example bug ticket format)
- US-009: Documentation & Tutorials (bug reporting guide)

---

ü§ñ **Created**: 2025-10-11 by code_developer (autonomous)
**Estimated Implementation Time**: 4-6 hours
**Priority**: Medium (improves bug tracking and developer workflow)
