# BUG-076: Architect crashes on missing PROACTIVE_REFACTORING_ANALYSIS enum value

**Priority**: HIGH
**Status**: RESOLVED
**Created**: 2025-10-20
**Resolved**: 2025-10-20
**Agent**: user_listener
**Type**: Architect Agent Bug / Enum Synchronization Issue

## Summary

The architect agent crashed this morning when attempting to run weekly refactoring analysis due to a missing enum value in `SkillNames`. The code referenced `SkillNames.PROACTIVE_REFACTORING_ANALYSIS` which did not exist in the enum definition.

## Evidence

**Status File (data/agent_status/architect_status.json):**
```json
{
  "agent_type": "architect",
  "state": "error",
  "current_task": {
    "type": "refactoring_analysis",
    "started_at": "2025-10-20T10:51:26.525361"
  },
  "last_heartbeat": "2025-10-20T10:51:26.526829",
  "health": "unhealthy",
  "pid": 69976,
  "error": "cannot import name 'SkillNames' from 'coffee_maker.autonomous.skill_loader'"
}
```

**Timeline:**
- 2025-10-20 10:51:26 AM: Architect started refactoring_analysis task
- Immediately crashed trying to access non-existent enum value
- Process 69976 terminated
- Status file preserved error (thanks to new status handling from commit 19c44da)

## Root Cause

**PRIMARY CAUSE**: Missing enum value synchronization

1. **Code Reference**: `architect_skills_mixin.py:392`
   ```python
   skill_prompt = load_skill(SkillNames.PROACTIVE_REFACTORING_ANALYSIS)
   ```

2. **Enum Definition**: `skill_loader.py:25-44`
   - MISSING: `PROACTIVE_REFACTORING_ANALYSIS = "proactive-refactoring-analysis"`
   - The skill file exists at `.claude/skills/proactive-refactoring-analysis/SKILL.md`
   - But enum value was never added when skill was created

3. **Error Mechanism**:
   - Accessing `SkillNames.PROACTIVE_REFACTORING_ANALYSIS` raises `AttributeError`
   - Stale .pyc cache made error message confusing ("cannot import name")
   - Clearing `__pycache__` directories temporarily masked the issue

4. **Why It Triggered Today**:
   - Architect runs weekly refactoring analysis (line 337-338 of architect_skills_mixin.py)
   - Triggered by Monday check: `if today.weekday() != 0: return False`
   - This was the first Monday since the skill code was added

## Impact

- **Architect completely down** for 13+ hours
- **Cannot create technical specifications** (blocking US-038, US-039, etc.)
- **Parallel execution blocked** waiting for specs
- **User confusion** from misleading error message

## Fix Implemented

**Commit**: 0bacf3c

### 1. Added Missing Enum Value
**File**: `coffee_maker/autonomous/skill_loader.py:32`
```python
# Architect skills
ARCHITECTURE_REUSE_CHECK = "architecture-reuse-check"
CONTINUOUS_SPEC_IMPROVEMENT = "continuous-spec-improvement"
CODE_REVIEW_HISTORY = "code-review-history"
PROACTIVE_REFACTORING_ANALYSIS = "proactive-refactoring-analysis"  # ← ADDED
```

### 2. Added Defensive Error Handling
**File**: `coffee_maker/autonomous/agents/architect_skills_mixin.py:392-397`
```python
try:
    skill_prompt = load_skill(SkillNames.PROACTIVE_REFACTORING_ANALYSIS)
except (AttributeError, FileNotFoundError) as e:
    logger.error(f"❌ Skill not available: {e}")
    logger.info("⏭️  Skipping refactoring analysis - skill not found")
    return
```

**Also Updated**: `architect_skills_mixin.py:576`
```python
except (AttributeError, FileNotFoundError) as e:  # Added AttributeError
    logger.warning(f"⚠️  architecture-reuse-check skill not found, proceeding without it: {e}")
```

## Prevention Strategy

### Short-term (Implemented):
✅ Defensive error handling catches `AttributeError` for missing enum values
✅ Agent gracefully skips analysis instead of crashing
✅ Clear error logging for debugging

### Long-term (Recommended):
- [ ] Add test: Validate all `SkillNames` references exist in codebase
- [ ] Add test: Validate all skill files have corresponding enum entries
- [ ] Consider auto-generating enum from skill directory structure
- [ ] Add pre-commit hook to check enum/skill synchronization

### Developer Guidelines:
When adding new skills:
1. Create skill file in `.claude/skills/{agent}/{skill-name}/SKILL.md`
2. Add corresponding enum value in `skill_loader.py`
3. Add import test in test suite
4. Use try/except when loading skills

## Verification

**Tests Performed:**
```bash
# 1. Import test
poetry run python -c "from coffee_maker.autonomous.skill_loader import SkillNames; print(SkillNames.PROACTIVE_REFACTORING_ANALYSIS)"
# ✅ Output: SkillNames.PROACTIVE_REFACTORING_ANALYSIS

# 2. Skill loading test
poetry run python -c "from coffee_maker.autonomous.skill_loader import load_skill, SkillNames; skill = load_skill(SkillNames.PROACTIVE_REFACTORING_ANALYSIS); print(f'✅ {len(skill)} chars')"
# ✅ Output: ✅ 10742 chars

# 3. Mixin import test
poetry run python -c "from coffee_maker.autonomous.agents.architect_skills_mixin import ArchitectSkillsMixin; print('✅ OK')"
# ✅ Output: ✅ OK
```

## Related

- Status file preservation: Commit 19c44da (preserved crash info instead of deleting)
- Activity summary: Shows crashes in "Recent Agent Issues" section
- US-034: Create architect Agent (this bug blocked architect operations)
- CFR-014: Database tracking (status files enabled debugging)

## Lessons Learned

1. **Status file preservation is critical**: The new approach (commit 19c44da) to preserve status files instead of deleting them made this bug visible and debuggable.

2. **Misleading error messages**: The error "cannot import name 'SkillNames'" was confusing - actual error was `AttributeError` on enum access.

3. **Enum synchronization is fragile**: Manual sync between skill files and enum values is error-prone. Consider automation.

4. **Defensive programming works**: Error handling prevented similar crashes in `_run_architecture_reuse_check_before_spec()` which already caught `FileNotFoundError`.

5. **Testing gaps**: No test validates that all skill references have corresponding enum values.
