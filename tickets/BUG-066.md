# BUG-066: ROADMAP parser inconsistency - agents use different parsers and miss user stories

**Status**: ðŸ”´ Open
**Priority**: Critical
**Created**: 2025-10-20
**Assigned**: user_listener
**Related**: ROADMAP.md, RoadmapParser, RoadmapManagementSkill

## Problem Description

Multiple ROADMAP parsers exist with different format support, causing agents to miss user stories.

**Current State**:
1. **RoadmapParser** (`coffee_maker/autonomous/roadmap_parser.py`) - Used by code_developer, architect, project_manager
   - Supports: `### PRIORITY X`, `### US-XXX` (triple hash)
   - Does NOT support: `## US-XXX` (double hash)

2. **RoadmapManagementSkill** (`.claude/skills/shared/roadmap-management/roadmap_management.py`) - Used by orchestrator
   - Supports: `### PRIORITY X` (triple hash only)
   - Does NOT support: `## US-XXX` (double hash)

3. **ROADMAP.md** uses BOTH formats:
   - Older entries: `### PRIORITY 1: Analytics âœ…`
   - Newer entries: `## US-110: Orchestrator Database Tracing`

## Impact

- Agents may not see new user stories (US-110, US-111, etc.)
- code_developer won't find next work items
- orchestrator won't coordinate properly
- architect won't create specs for new user stories
- project_manager metrics will be incomplete

## Root Cause

- No single source of truth for ROADMAP parsing
- Two separate parser implementations
- ROADMAP format evolved but parsers didn't update

## Examples of Missed User Stories

```bash
# Visible to parsers (triple hash)
### PRIORITY 1: Analytics âœ… Complete

# INVISIBLE to parsers (double hash)
## US-110: Orchestrator Database Tracing
## US-111: Web App (to be added)
```

## Reproduction Steps

1. Check parsers:
   ```bash
   grep -n "pattern.*PRIORITY" coffee_maker/autonomous/roadmap_parser.py
   grep -n "priority_pattern" .claude/skills/shared/roadmap-management/roadmap_management.py
   ```

2. Check ROADMAP formats:
   ```bash
   grep "^##[^#]" docs/roadmap/ROADMAP.md | head -5  # Double hash
   grep "^###[^#]" docs/roadmap/ROADMAP.md | head -5  # Triple hash
   ```

3. Run parser test:
   ```bash
   poetry run python3 -c "from coffee_maker.autonomous.roadmap_parser import RoadmapParser; p = RoadmapParser('docs/roadmap/ROADMAP.md'); print(len([x for x in p.get_priorities() if 'US-110' in str(x)]))"
   # Output: 0 (US-110 not found!)
   ```

## Solution

### Phase 1: Unify Parsers
1. Update `RoadmapParser` to support both `##` and `###` formats
2. Make it the single source of truth
3. Update `RoadmapManagementSkill` to use `RoadmapParser` internally

### Phase 2: Update All Agents
1. Ensure all agents use the unified `RoadmapManagementSkill`
2. Remove direct `RoadmapParser` imports where possible
3. Standardize ROADMAP access pattern

### Phase 3: Testing
1. Test parser with all ROADMAP formats
2. Verify all agents can see all user stories
3. Integration tests for all agent types

## Files to Modify

- `coffee_maker/autonomous/roadmap_parser.py` - Add `##` support
- `.claude/skills/shared/roadmap-management/roadmap_management.py` - Use RoadmapParser
- `coffee_maker/autonomous/agents/code_developer_agent.py` - Use skill
- `coffee_maker/autonomous/agents/architect_agent.py` - Use skill
- `coffee_maker/cli/project_manager.py` - Use skill
- `coffee_maker/orchestrator/continuous_work_loop.py` - Already uses skill âœ…

## Success Criteria

- [ ] RoadmapParser supports both `##` and `###` formats
- [ ] All agents use unified RoadmapManagementSkill
- [ ] Parser test finds US-110 correctly
- [ ] All 110+ user stories visible to all agents
- [ ] Integration tests pass

---

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>
