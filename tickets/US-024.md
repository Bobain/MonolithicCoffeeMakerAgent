# US-024: Frequent Roadmap Branch Synchronization

**Status**: 📝 Planned
**Priority**: High
**Estimate**: 2-3 hours

## User Story
As a **code_developer**,
I want to **merge my active branch into roadmap frequently**,
So that **project_manager is aware of the progress** by looking at the roadmap branch and can see incremental updates instead of only seeing completed work.

## Problem
Currently, the code_developer workflow is:
1. Works on feature branches (e.g., `feature/us-021-refactoring-phase-1`)
2. Only merges to roadmap when work is fully complete
3. Project_manager can't see work-in-progress
4. User must switch branches to see current progress
5. ROADMAP.md updates are invisible until final merge

**Impact**:
- 🚫 No visibility into incremental progress
- 🚫 Project_manager can't provide early feedback
- 🚫 User doesn't know what code_developer is doing right now
- 🚫 Progress updates in ROADMAP.md aren't visible on roadmap branch
- 🚫 Harder to coordinate between daemon and user

## Proposed Solution
Implement a **"merge early, merge often"** strategy where code_developer merges to roadmap branch after each logical unit of work.

### When to Merge to Roadmap

**Trigger Events** (code_developer should merge after ANY of these):
1. ✅ **Completed a sub-task** - Any checkbox in a user story marked complete
2. ✅ **Pushed commits** - After every 3-5 commits to feature branch
3. ✅ **Updated ROADMAP.md** - Immediately after updating progress
4. ✅ **End of work session** - Before going idle/sleeping
5. ✅ **Created new files** - New user stories, specs, documentation
6. ✅ **Daily checkpoint** - At least once per 24 hours if active

**Examples**:
```bash
# After completing ConfigManager migration (15 files)
git checkout roadmap
git merge feature/us-021-refactoring-phase-1 --no-ff
git push origin roadmap

# After updating ROADMAP.md with progress
git checkout roadmap
git merge feature/us-021-refactoring-phase-1 --no-ff
git push origin roadmap

# After creating US-023.md
git checkout roadmap
git merge feature/us-021-refactoring-phase-1 --no-ff
git push origin roadmap
```

## Workflow Changes

### Current Workflow (Problematic)
```
feature/us-021 ──┬──┬──┬──┬──┬──┬──> (many commits)
                 │  │  │  │  │  │
roadmap ─────────┴──┴──┴──┴──┴──┴──> (no updates until PR)

User sees: NOTHING until PR merged
```

### New Workflow (Improved)
```
feature/us-021 ──┬──┬──┬──┬──┬──┬──> (many commits)
                 │  │  │  │  │  │
                 ↓  ↓  ↓  ↓  ↓  ↓
roadmap ─────────●──●──●──●──●──●──> (frequent merges)

User sees: REAL-TIME progress updates
```

## Implementation Plan

### Phase 1: Daemon Enhancement (1 hour)
Add `_merge_to_roadmap()` method to DevDaemon that:
1. Checks if on feature branch
2. Commits any uncommitted changes
3. Switches to roadmap branch
4. Merges feature branch with `--no-ff` (preserves history)
5. Handles conflicts (abort and notify user)
6. Pushes to origin/roadmap
7. Switches back to feature branch

```python
def _merge_to_roadmap(self, message: str = "Sync progress to roadmap") -> bool:
    """Merge current feature branch to roadmap branch.

    This keeps roadmap branch synchronized with incremental progress.

    Args:
        message: Commit message if uncommitted changes exist

    Returns:
        True if merge successful, False if conflicts or errors
    """
    try:
        # Get current branch
        current_branch = subprocess.check_output(
            ["git", "branch", "--show-current"],
            text=True
        ).strip()

        if current_branch == "roadmap":
            LOGGER.warning("Already on roadmap branch, skipping merge")
            return True

        # Commit any uncommitted changes
        status = subprocess.check_output(["git", "status", "--porcelain"], text=True)
        if status.strip():
            subprocess.run(["git", "add", "-A"], check=True)
            subprocess.run(["git", "commit", "-m", message], check=True)
            subprocess.run(["git", "push", "origin", current_branch], check=True)

        # Switch to roadmap
        subprocess.run(["git", "checkout", "roadmap"], check=True)
        subprocess.run(["git", "pull", "origin", "roadmap"], check=True)

        # Merge feature branch (--no-ff preserves history)
        merge_result = subprocess.run(
            ["git", "merge", "--no-ff", "-m", f"Merge {current_branch}: {message}", current_branch],
            capture_output=True,
            text=True
        )

        if merge_result.returncode != 0:
            # Conflict detected
            subprocess.run(["git", "merge", "--abort"], check=True)
            subprocess.run(["git", "checkout", current_branch], check=True)

            self._create_notification(
                "merge_conflict",
                f"MERGE CONFLICT: {current_branch} → roadmap",
                f"Automatic merge to roadmap failed with conflicts. Please resolve manually."
            )
            return False

        # Push to origin
        subprocess.run(["git", "push", "origin", "roadmap"], check=True)

        # Switch back to feature branch
        subprocess.run(["git", "checkout", current_branch], check=True)

        LOGGER.info(f"Successfully merged {current_branch} → roadmap")
        return True

    except Exception as e:
        LOGGER.error(f"Failed to merge to roadmap: {e}")
        # Try to recover to feature branch
        try:
            subprocess.run(["git", "checkout", current_branch], check=True)
        except:
            pass
        return False
```

### Phase 2: Integration Points (30 minutes)
Call `_merge_to_roadmap()` at strategic points:

1. **After completing sub-task**:
```python
def _execute_priority_implementation(self, priority):
    # ... existing implementation ...

    # After each logical unit of work
    if self._check_progress_made():
        self._merge_to_roadmap(f"Progress on {priority['name']}")
```

2. **After updating ROADMAP.md**:
```python
def _update_roadmap_status(self, priority, status):
    # ... update ROADMAP.md ...

    # Immediately sync to roadmap branch
    self._merge_to_roadmap(f"Update {priority['name']} status: {status}")
```

3. **After creating tickets**:
```python
def _create_user_story_ticket(self, ticket_path):
    # ... create ticket ...

    # Sync new ticket to roadmap
    self._merge_to_roadmap(f"Create {os.path.basename(ticket_path)}")
```

4. **Before sleep**:
```python
def run(self):
    while True:
        # ... iteration ...

        # Merge progress before sleeping
        self._merge_to_roadmap("End of iteration checkpoint")

        time.sleep(self.sleep_interval)
```

### Phase 3: Documentation (30 minutes)
Update docs to reflect new workflow:

**Files to Update**:
- `docs/COLLABORATION_METHODOLOGY.md` - Section 6: Git Workflow
- `docs/DAEMON_GUIDE.md` - Branch strategy
- `docs/roadmap/ROADMAP.md` - Workflow notes

**Key Points to Document**:
- Roadmap branch is the "source of truth" for current progress
- Feature branches merge to roadmap frequently (not just at PR time)
- Project_manager always views roadmap branch
- Main branch is for production-ready code only

### Phase 4: Testing (30 minutes)
Test the merge workflow:
- [ ] Test successful merge (no conflicts)
- [ ] Test merge with conflicts (should abort gracefully)
- [ ] Test merge from various feature branches
- [ ] Test recovery when merge fails
- [ ] Verify roadmap branch stays updated

## Acceptance Criteria

### Must Have
- [ ] `_merge_to_roadmap()` method implemented in DevDaemon
- [ ] Daemon merges to roadmap after completing sub-tasks
- [ ] Daemon merges to roadmap after updating ROADMAP.md
- [ ] Daemon merges to roadmap before sleeping
- [ ] Conflicts are detected and handled gracefully (abort + notify)
- [ ] Feature branch preserved and switched back after merge
- [ ] Merge commits use `--no-ff` flag (preserves history)
- [ ] COLLABORATION_METHODOLOGY.md updated with workflow

### Should Have
- [ ] Configurable merge frequency (e.g., every N commits)
- [ ] Dry-run mode to test merge without executing
- [ ] Merge skipped if no changes since last merge
- [ ] Notification sent after successful merge
- [ ] Merge statistics tracked (success/failure rate)

### Nice to Have
- [ ] Auto-resolve simple conflicts (e.g., ROADMAP.md progress updates)
- [ ] Merge queue for batching multiple changes
- [ ] Rollback capability if merge causes issues
- [ ] Dashboard showing last merge time per feature branch

## Benefits

### For Project_Manager
- ✅ **Real-time visibility** - See progress as it happens
- ✅ **Early feedback** - Can spot issues before work is complete
- ✅ **Better coordination** - Know what daemon is working on right now
- ✅ **Incremental updates** - ROADMAP.md always current

### For Code_Developer
- ✅ **Safer workflow** - Frequent small merges easier than big bang merge
- ✅ **Less conflict risk** - Smaller changesets = fewer conflicts
- ✅ **Better checkpoints** - Can recover from any roadmap merge point
- ✅ **Clearer history** - Git log shows incremental progress

### For User
- ✅ **Transparency** - Can see what's happening without asking
- ✅ **Confidence** - Regular updates show system is working
- ✅ **Better planning** - Know when to expect deliverables
- ✅ **Easy testing** - Can checkout roadmap to test latest work

## Risks & Mitigations

### Risk 1: Merge Conflicts
**Likelihood**: Medium
**Impact**: Medium
**Mitigation**:
- Abort merge automatically and notify user
- Clear instructions for manual resolution
- Test conflict handling thoroughly

### Risk 2: Broken Code on Roadmap Branch
**Likelihood**: Low (tests run before commits)
**Impact**: Low (main branch unaffected)
**Mitigation**:
- Run pre-commit hooks before merge
- Feature branches still exist for recovery
- Roadmap branch is not production

### Risk 3: Performance Impact
**Likelihood**: Low
**Impact**: Low
**Mitigation**:
- Merge operation is fast (<5 seconds)
- Only merge when progress made
- Skip merge if no changes

### Risk 4: Too Frequent Merges
**Likelihood**: Medium
**Impact**: Low (more noise in git history)
**Mitigation**:
- Configurable merge frequency
- Use meaningful merge messages
- `--no-ff` flag keeps history clean

## Success Metrics

**After Implementation**:
- Roadmap branch is ≤ 1 hour behind feature branches
- >80% of progress updates visible on roadmap within 30 minutes
- Merge conflict rate < 5%
- Average merge time < 10 seconds
- User satisfaction with progress visibility improved

## Related User Stories
- US-021: Code Refactoring (current work)
- BUG-002: Daemon Roadmap Synchronization
- US-009: Process Management & Status Monitoring

## Example Workflow

### Scenario: code_developer working on US-021 Phase 1

```bash
# 1. Start work on feature branch
git checkout -b feature/us-021-refactoring-phase-1

# 2. Complete ConfigManager migration (15 files)
# ... make changes ...
git add -A
git commit -m "refactor: Migrate 15 files to ConfigManager"
git push origin feature/us-021-refactoring-phase-1

# 3. ✨ AUTO-MERGE to roadmap (daemon does this)
git checkout roadmap
git pull origin roadmap
git merge --no-ff feature/us-021-refactoring-phase-1 \
  -m "Merge feature/us-021: ConfigManager migration complete"
git push origin roadmap
git checkout feature/us-021-refactoring-phase-1

# 4. Update ROADMAP.md with progress
# ... update docs/roadmap/ROADMAP.md ...
git add docs/roadmap/ROADMAP.md
git commit -m "docs: Update US-021 progress (ConfigManager complete)"
git push origin feature/us-021-refactoring-phase-1

# 5. ✨ AUTO-MERGE to roadmap (daemon does this)
git checkout roadmap
git merge --no-ff feature/us-021-refactoring-phase-1 \
  -m "Merge feature/us-021: Update ROADMAP.md progress"
git push origin roadmap
git checkout feature/us-021-refactoring-phase-1

# 6. Create US-023.md user story
# ... create tickets/US-023.md ...
git add tickets/US-023.md
git commit -m "docs: Create US-023 for settings management"
git push origin feature/us-021-refactoring-phase-1

# 7. ✨ AUTO-MERGE to roadmap (daemon does this)
git checkout roadmap
git merge --no-ff feature/us-021-refactoring-phase-1 \
  -m "Merge feature/us-021: Create US-023 ticket"
git push origin roadmap
git checkout feature/us-021-refactoring-phase-1
```

**Result**:
- Roadmap branch has 3 merge commits showing incremental progress
- Project_manager can see ConfigManager is done, ROADMAP updated, US-023 created
- User can checkout roadmap branch and test ConfigManager immediately
- No waiting until PR is merged to see progress

## Technical Notes

### Git Merge Strategy
- Use `--no-ff` (no fast-forward) to preserve feature branch history
- Use `--no-edit` to skip interactive commit message editor
- Always pull roadmap before merging to avoid divergence

### Branch Naming
- Feature branches: `feature/us-XXX-description`
- Roadmap branch: `roadmap` (always)
- Main branch: `main` (production only)

### Merge Commit Messages
Format: `Merge feature/us-XXX: <description>`

Examples:
- `Merge feature/us-021: ConfigManager migration complete`
- `Merge feature/us-021: Update ROADMAP.md progress`
- `Merge feature/us-023: Create settings management ticket`

## Implementation Checklist

- [ ] Create `_merge_to_roadmap()` method in `coffee_maker/autonomous/daemon.py`
- [ ] Add merge call after sub-task completion
- [ ] Add merge call after ROADMAP.md updates
- [ ] Add merge call before sleep/idle
- [ ] Add merge call after ticket creation
- [ ] Implement conflict detection and abort
- [ ] Add notification on merge failure
- [ ] Update COLLABORATION_METHODOLOGY.md
- [ ] Update DAEMON_GUIDE.md
- [ ] Add unit tests for merge logic
- [ ] Add integration tests for merge workflow
- [ ] Test manual conflict resolution
- [ ] Verify performance impact acceptable
- [ ] Mark US-024 complete

---

🤖 **Created**: 2025-10-11 by code_developer (autonomous)
**Estimated Implementation Time**: 2-3 hours
**Priority**: High (improves developer experience and user visibility)
