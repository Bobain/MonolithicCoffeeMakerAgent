# BUG-071: Orchestrator fails to create worktree - branch already exists

**Status**: ✅ Fixed
**Priority**: High
**Created**: 2025-10-20T17:33:58.194995
**Reporter**: User
**Assigned**: code_developer

## Description

Orchestrator continuous work loop repeatedly fails to create worktree with error:
'fatal : Une branche nommée 'roadmap-wt1' existe déjà'

The error occurs every 30 seconds during the polling cycle when trying to create worktree for US-038 implementation.
This blocks parallel execution and causes unnecessary error logging.

Root cause: Branches from previous worktrees are not being cleaned up properly.

## Reproduction Steps

1. Start orchestrator with 'poetry run orchestrator start'
2. Wait for polling cycle (30s)
3. Observe error: 'Failed to create worktree: fatal : Une branche nommée roadmap-wt1 existe déjà'
4. Error repeats every 30 seconds

## Expected Behavior

_To be determined during analysis_

## Actual Behavior

_To be determined during analysis_

## Definition of Done

- [ ] Bug reproduced locally
- [ ] Root cause identified
- [ ] Technical specification written
- [ ] Fix implemented
- [ ] Regression tests added
- [ ] All tests passing
- [ ] No regressions in existing functionality
- [ ] Documentation updated if needed
- [ ] PR created and reviewed
- [ ] User validated fix

## Analysis (code_developer)

**Root Cause Identified** ✅

The bug occurs in `continuous_work_loop.py:839` in the `_generate_worktree_id()` function.

**Problem:**
1. Function only checks database for active agents to find max worktree number
2. When all agents complete and are cleaned from database, `max_wt_num = 0`
3. Function returns "wt1" every time
4. If branch `roadmap-wt1` still exists in git (from failed cleanup or crash), creation fails

**Evidence:**
```bash
$ git branch -a | grep roadmap-wt
+ roadmap-wt1  # Branch exists but no active agent owns it
```

**Expected Behavior:**
- Function should check BOTH database AND git branches
- Should find next available ID that doesn't conflict with existing branches
- Should handle orphaned branches gracefully

**Actual Behavior:**
- Function only checks database
- Returns duplicate ID "wt1" when database is clean
- Fails with "fatal : Une branche nommée 'roadmap-wt1' existe déjà"

## Technical Spec (code_developer)

**Fix Location:** `coffee_maker/orchestrator/continuous_work_loop.py:839-872`

**Solution:** Enhance `_generate_worktree_id()` to check git branches in addition to database

**Implementation Steps:**
1. Keep existing database query for active agents
2. Add git query to list all branches matching `roadmap-wt*`
3. Extract numbers from both sources
4. Find max from combined list
5. Return `next_id = max + 1`

**Code Changes:**
```python
def _generate_worktree_id(self) -> str:
    # Step 1: Check database for active agents (existing logic)
    max_wt_num = 0
    # ... existing database query ...

    # Step 2: Check git for existing branches (NEW)
    try:
        result = subprocess.run(
            ["git", "branch", "--list", "roadmap-wt*"],
            cwd=self.repo_root,
            capture_output=True,
            text=True,
            timeout=10,
        )
        for line in result.stdout.splitlines():
            # Extract number from "  roadmap-wt5" -> 5
            match = re.search(r'roadmap-wt(\d+)', line.strip())
            if match:
                wt_num = int(match.group(1))
                max_wt_num = max(max_wt_num, wt_num)
    except Exception as e:
        logger.warning(f"Failed to check git branches: {e}")

    # Step 3: Return next available ID
    return f"wt{max_wt_num + 1}"
```

**Safety:** Maintains fallback to timestamp-based ID on database errors

## Implementation (code_developer)

**Changes Made:** ✅

**File:** `coffee_maker/orchestrator/continuous_work_loop.py`

**Changes:**
1. Added `import re` at line 27
2. Enhanced `_generate_worktree_id()` function (lines 839-896):
   - Added git branch query to check for orphaned branches
   - Uses `git branch --list roadmap-wt*` to find existing branches
   - Extracts numbers from both database and git branches
   - Returns max + 1 to avoid conflicts

**Code Review:**
- Maintains existing fallback to timestamp-based ID on errors
- Adds warning log if git branch check fails
- Regex pattern handles both formats: "  roadmap-wt5" and "+ roadmap-wt5"
- Timeout set to 10 seconds for git command safety

## Testing Results (code_developer)

**Manual Testing:** ✅ PASSED

**Test Setup:**
- Orphaned branch `roadmap-wt1` exists in git
- No active agents in database own this branch
- Orchestrator restarted with fix applied

**Test Results:**
```
Before Fix:
  ❌ Failed to create worktree: fatal : Une branche nommée 'roadmap-wt1' existe déjà
  (Error repeated every 30s)

After Fix:
  ✅ Created worktree: ../worktree-wt2 (branch: roadmap-wt2)
  ✅ code_developer spawned for US-038 (PID: 26069, worktree: ../worktree-wt2)
```

**Verification:**
- Orchestrator detected existing roadmap-wt1 branch
- Generated wt2 as next available ID
- Successfully created worktree and spawned code_developer
- No errors in logs

## Regression Test

**Test File**: _Path to test file (e.g., `tests/test_bug_066_roadmap_parser.py`)_

**Test Name**: _Test function name (e.g., `test_roadmap_parser_supports_double_hash`)_

**Coverage**:
- [ ] Bug reproduction test added (fails before fix, passes after fix)
- [ ] Edge cases covered
- [ ] Test runs in CI/CD pipeline
- [ ] Test documentation added

**Notes**: _Additional testing notes, edge cases, or related tests_

## PR Link

_Phase 5: PR Creation - To be filled by code_developer_

---

**Workflow**: User → project-manager → code_developer → Analysis → Tech Spec → Implementation → Testing → Regression Test → PR → Done
