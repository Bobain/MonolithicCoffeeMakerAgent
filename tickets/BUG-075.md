# BUG-075: Parallel code_developers not registered in agent_lifecycle database

**Priority**: HIGH
**Status**: OPEN
**Created**: 2025-10-20
**Agent**: user_listener
**Type**: Orchestrator / Database Tracking Bug

## Summary

When the `ParallelExecutionCoordinator` spawns code_developer instances in worktrees, they are NOT registered in the `agent_lifecycle` database table. This makes them invisible to:
- The orchestrator dashboard
- Agent monitoring queries
- Any CFR-014 compliant tracking

## Evidence

**Database Query:**
```bash
sqlite3 data/orchestrator.db "SELECT * FROM active_agents;"
```

Shows only 3 agents (1 project_manager, 2 code-reviewers), but **NOT** the 3 active code_developers running in worktrees.

**Running Processes:**
```
PID 81957 - code_developer PRIORITY 038 (running for 5+ min)
PID 81958 - code_developer PRIORITY 039 (running for 5+ min)
PID 81959 - code_developer PRIORITY 045 (running for 5+ min)
```

**Code Location:**
`coffee_maker/orchestrator/parallel_execution_coordinator.py:396`
```python
process = subprocess.Popen(
    cmd, cwd=worktree.worktree_path, stdout=stdout_f, stderr=stderr_f, text=True
)
```

No database registration happens after this spawn.

## Root Cause

`ParallelExecutionCoordinator` spawns processes directly with `subprocess.Popen` without using `OrchestratorAgentManagementSkill` to register them in the database.

**Compare to correct approach in `continuous_work_loop.py`:**
- Uses `agent_mgmt.execute(action="spawn_architect", ...)`
- Uses `agent_mgmt.execute(action="spawn_code_developer", ...)`
- These register agents in `agent_lifecycle` table

## Impact

- **Dashboard shows no active agents** even though 3 are running
- **Monitoring tools can't track parallel execution**
- **CFR-014 violation** - not all orchestrator activities in database
- **User confusion** - appears like nothing is working

## Fix Required

1. Import `OrchestratorAgentManagementSkill` in `parallel_execution_coordinator.py`
2. After spawning each code_developer (line 396), register it:
   ```python
   agent_mgmt.execute(
       action="record_spawn",
       pid=process.pid,
       agent_type="code_developer",
       task_id=f"priority-{worktree.priority_id}",
       priority_number=int(worktree.priority_id),
       command=" ".join(cmd),
       worktree_path=str(worktree.worktree_path)
   )
   ```
3. Update agent status when monitoring detects completion
4. Clean up agent records when worktrees are removed

## Acceptance Criteria

- [ ] Parallel code_developers appear in `agent_lifecycle` table when spawned
- [ ] Dashboard shows all active code_developers
- [ ] Agent status updates to 'completed' or 'failed' when done
- [ ] `active_agents` view includes parallel execution agents
- [ ] CFR-014 compliant - all agent activity tracked in database

## Testing

1. Start orchestrator with parallel execution
2. Query database: `SELECT * FROM active_agents;`
3. Verify all spawned code_developers are present
4. Run dashboard: `poetry run orchestrator dashboard`
5. Confirm dashboard shows parallel agents

## Related

- CFR-014 (Database Tracking)
- US-108 (Parallel Execution - PRIORITY 23)
- `parallel_execution_coordinator.py:396`
- `agent_management.py` (skill for registration)
