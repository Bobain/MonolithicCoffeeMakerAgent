# US-027: Roadmap Branch as Single Source of Truth for Priorities

**Status**: 📝 Planned
**Priority**: High
**Estimate**: 2-3 hours

## User Story
As a **developer**,
I need **the roadmap branch to always be up-to-date with the ROADMAP.md file**,
So that I can **know what my next priority is** without checking multiple branches or locations.

## Problem
Currently, the ROADMAP.md file can be out of sync across branches:
- ❌ Feature branches may have stale ROADMAP.md
- ❌ Main branch only gets updates after PR merge
- ❌ Developer doesn't know which branch has the "true" priorities
- ❌ code_developer may work on outdated priorities
- ❌ No single source of truth for current work

**Impact**:
- Developer works on wrong priorities
- Duplicate work across branches
- Confusion about what's next
- Roadmap drift between branches
- Poor coordination between developers

## Proposed Solution
Establish **roadmap branch as the single source of truth** for ROADMAP.md, with strict synchronization rules:

### Core Principle
> **The `roadmap` branch ALWAYS has the most current ROADMAP.md**
>
> All priority decisions, status updates, and planning changes MUST go through roadmap branch first.

---

## Implementation Rules

### Rule 1: Direct Roadmap Updates Only on `roadmap` Branch

**Who Can Update ROADMAP.md**:
- ✅ project_manager (via chat interface)
- ✅ code_developer (automatic updates)
- ✅ User (manual edits on roadmap branch)

**Where Updates Happen**:
- ✅ Always commit to `roadmap` branch
- ❌ Never edit ROADMAP.md on feature branches
- ❌ Never edit ROADMAP.md on main branch directly

### Rule 2: Feature Branches Sync FROM Roadmap

When starting work on a feature:
```bash
# CORRECT: Sync roadmap first, then create feature branch
git checkout roadmap
git pull origin roadmap
git checkout -b feature/us-XXX

# INCORRECT: Create feature branch from outdated main
git checkout main  # ❌ Don't do this
git checkout -b feature/us-XXX
```

### Rule 3: code_developer Syncs Before Each Iteration

The daemon MUST:
1. Fetch `origin/roadmap`
2. Merge into current branch (or reset if conflicts)
3. Read ROADMAP.md for next priority
4. Update ROADMAP.md with progress
5. Merge changes back to roadmap immediately

**Implementation in daemon.py**:
```python
def _sync_roadmap_branch(self) -> bool:
    """Sync with roadmap branch at start of iteration.

    This ensures daemon always works with latest priorities.
    ROADMAP.md on roadmap branch is the single source of truth.

    Returns:
        True if sync successful, False if conflicts
    """
    try:
        LOGGER.info("Syncing with roadmap branch (single source of truth)")

        # Fetch latest roadmap
        subprocess.run(
            ["git", "fetch", "origin", "roadmap"],
            check=True,
            capture_output=True
        )

        # Get current branch
        current_branch = subprocess.check_output(
            ["git", "branch", "--show-current"],
            text=True
        ).strip()

        # Merge roadmap into current branch
        merge_result = subprocess.run(
            ["git", "merge", "origin/roadmap", "-m", "Sync with roadmap (source of truth)"],
            capture_output=True,
            text=True
        )

        if merge_result.returncode != 0:
            # Conflict - abort and notify
            subprocess.run(["git", "merge", "--abort"], check=True)
            self._create_notification(
                "roadmap_sync_conflict",
                "Cannot sync with roadmap branch",
                f"Merge conflicts prevent syncing ROADMAP.md. Manual resolution required."
            )
            return False

        LOGGER.info("✅ Synced with roadmap branch successfully")
        return True

    except Exception as e:
        LOGGER.error(f"Failed to sync with roadmap branch: {e}")
        return False
```

### Rule 4: Progress Updates Go to Roadmap Immediately

When code_developer updates ROADMAP.md:
```python
def _update_roadmap_progress(self, priority_name: str, status: str):
    """Update priority status in ROADMAP.md.

    CRITICAL: Updates must be merged to roadmap branch immediately
    to maintain it as single source of truth.
    """
    # Update ROADMAP.md locally
    self._modify_roadmap_file(priority_name, status)

    # Commit changes
    subprocess.run([
        "git", "add", "docs/roadmap/ROADMAP.md"
    ], check=True)

    subprocess.run([
        "git", "commit", "-m",
        f"docs: Update {priority_name} status to {status}"
    ], check=True)

    # Push to feature branch
    subprocess.run([
        "git", "push", "origin", self.current_branch
    ], check=True)

    # 🔥 CRITICAL: Merge to roadmap immediately
    self._merge_to_roadmap(f"Update {priority_name} progress")
```

### Rule 5: Project Manager Reads FROM Roadmap Branch

**project-manager CLI behavior**:
```python
# CORRECT: Always read from roadmap branch
ROADMAP_PATH = Path("docs/roadmap/ROADMAP.md")

def get_roadmap():
    """Get current roadmap.

    IMPORTANT: project-manager should be run on roadmap branch
    to see latest priorities.
    """
    # Verify we're on roadmap branch
    current_branch = subprocess.check_output(
        ["git", "branch", "--show-current"],
        text=True
    ).strip()

    if current_branch != "roadmap":
        print("⚠️  WARNING: Not on roadmap branch!")
        print("   For latest priorities, switch to roadmap branch:")
        print("   git checkout roadmap && git pull")
        print()

    return ROADMAP_PATH.read_text()
```

---

## 🎯 The Complete Picture: US-024 + US-027 = Visibility Loop

**US-024** (Developer Side) + **US-027** (Manager Side) work together to create a continuous visibility loop:

```
  US-024 (Developer Side):
  - code_developer merges frequently
  - After completing work
  - Before going idle
  - Keeps roadmap fresh

  US-027 (Manager Side):
  - project_manager sees updates
  - roadmap branch is source of truth
  - Always shows current state
  - Real-time priority visibility

  Together They Create:

  code_developer               project_manager
       ↓                              ↓
    [Work]                       [Monitor]
       ↓                              ↓
  [Merge to roadmap] ──────→ [See updates immediately]
       ↓                              ↓
    [Continue]                  [Provide feedback]
       ↑                              ↓
       └──────────[Early course correction]
```

**Benefits of the Loop**:
- ✅ **Continuous Visibility**: Manager always sees current work
- ✅ **Fast Feedback**: Can provide input before work completes
- ✅ **Course Correction**: Catch issues early
- ✅ **Confidence**: Both sides know what's happening
- ✅ **Coordination**: No surprises, no delays

---

## Workflow Diagrams

### Current Problem (Inconsistent State)

```
main branch:
  docs/roadmap/ROADMAP.md (outdated - waiting for PR merge)

feature/us-021:
  docs/roadmap/ROADMAP.md (modified - but not visible to others)

roadmap branch:
  docs/roadmap/ROADMAP.md (maybe updated, maybe not - unclear!)

Developer: "Which one is correct?" 🤔
```

### Proposed Solution (Roadmap as Source of Truth)

```
roadmap branch:
  docs/roadmap/ROADMAP.md ← 🎯 SINGLE SOURCE OF TRUTH
      ↑                Always current
      │                Always pushed
      │                Always merged
      │
      ├─── code_developer syncs FROM here
      ├─── project_manager reads FROM here
      ├─── feature branches sync FROM here
      └─── main syncs FROM here (after PR)

flow:
1. code_developer reads ROADMAP.md from roadmap
2. code_developer updates ROADMAP.md locally
3. code_developer merges to roadmap immediately
4. roadmap branch updated ✅
5. Next iteration: sync FROM roadmap again
```

### Synchronization Flow

```
┌──────────────────────────────────────────────────────────┐
│  ITERATION START                                         │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  1. git fetch origin roadmap                             │
│  2. git merge origin/roadmap                             │
│     └─> ROADMAP.md updated ✅                            │
│                                                          │
│  3. Read ROADMAP.md for next priority                    │
│     └─> Priority: US-XXX 📋                              │
│                                                          │
│  4. Implement feature...                                 │
│     └─> Work completed ✅                                │
│                                                          │
│  5. Update ROADMAP.md with progress                      │
│     └─> Status: 🔄 In Progress                           │
│                                                          │
│  6. git commit -m "docs: Update US-XXX progress"         │
│  7. git push origin feature/us-XXX                       │
│                                                          │
│  8. MERGE TO ROADMAP (US-024 workflow)                   │
│     git checkout roadmap                                 │
│     git merge --no-ff feature/us-XXX                     │
│     git push origin roadmap                              │
│     └─> roadmap branch updated ✅                        │
│                                                          │
│  9. git checkout feature/us-XXX                          │
│                                                          │
│  NEXT ITERATION: Sync FROM roadmap again (step 1)        │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## Technical Implementation

### Phase 1: Daemon Enhancement (1 hour)

**File**: `coffee_maker/autonomous/daemon.py`

**Changes**:
1. Add `_sync_roadmap_branch()` at start of each iteration
2. Call `_merge_to_roadmap()` after ROADMAP.md updates (US-024)
3. Add validation: Ensure ROADMAP.md changes go to roadmap

```python
def run(self):
    """Main daemon loop with roadmap sync."""
    iteration = 0

    while True:
        iteration += 1
        LOGGER.info(f"\n{'='*60}")
        LOGGER.info(f"ITERATION {iteration}")
        LOGGER.info(f"{'='*60}\n")

        # 🔥 STEP 1: Sync with roadmap branch (source of truth)
        if not self._sync_roadmap_branch():
            LOGGER.warning("Cannot sync with roadmap - skipping iteration")
            time.sleep(self.sleep_interval)
            continue

        # STEP 2: Parse ROADMAP.md (now guaranteed to be latest)
        next_priority = self.parser.get_next_planned_priority()

        if not next_priority:
            LOGGER.info("No planned priorities - going idle")
            time.sleep(self.sleep_interval)
            continue

        # STEP 3: Work on priority...
        self._execute_priority(next_priority)

        # STEP 4: Update ROADMAP.md with progress
        self._update_roadmap_progress(
            next_priority['name'],
            "🔄 In Progress"
        )

        # 🔥 STEP 5: Merge to roadmap immediately (US-024)
        self._merge_to_roadmap(
            f"Update {next_priority['name']} progress"
        )

        # STEP 6: Sleep before next iteration
        time.sleep(self.sleep_interval)
```

### Phase 2: Project Manager Enhancement (30 minutes)

**File**: `coffee_maker/cli/roadmap_cli.py`

**Changes**:
1. Add branch check in `cmd_view()`
2. Warn user if not on roadmap branch
3. Provide instructions to switch

```python
def cmd_view(args: argparse.Namespace) -> int:
    """View roadmap (single source of truth check)."""

    # Check current branch
    try:
        current_branch = subprocess.check_output(
            ["git", "branch", "--show-current"],
            text=True
        ).strip()

        if current_branch != "roadmap":
            print()
            print("⚠️  " + "="*70)
            print("⚠️  WARNING: You are NOT on the roadmap branch!")
            print("⚠️  " + "="*70)
            print()
            print(f"   Current branch: {current_branch}")
            print(f"   Roadmap branch is the SINGLE SOURCE OF TRUTH for priorities")
            print()
            print("   To view latest priorities:")
            print("   $ git checkout roadmap && git pull")
            print()
            print("   Showing roadmap from current branch (may be outdated)")
            print("   " + "="*70)
            print()
    except:
        pass  # Not in git repo or git not available

    # Display roadmap as usual...
    if not ROADMAP_PATH.exists():
        print(f"❌ ROADMAP not found: {ROADMAP_PATH}")
        return 1

    # ... rest of implementation
```

### Phase 3: Documentation Updates (30 minutes)

**Files to Update**:
1. `docs/COLLABORATION_METHODOLOGY.md` - Section on roadmap branch
2. `docs/DAEMON_GUIDE.md` - Sync behavior
3. `README.md` - Getting started with roadmap branch

**Key Documentation Points**:
```markdown
## Roadmap Branch: Single Source of Truth

**IMPORTANT**: The `roadmap` branch contains the authoritative ROADMAP.md file.

### For Developers

When starting work:
```bash
# 1. Always start from roadmap branch
git checkout roadmap
git pull origin roadmap

# 2. Create feature branch from roadmap
git checkout -b feature/us-XXX

# 3. Check priorities
cat docs/roadmap/ROADMAP.md
```

### For Project Manager Users

Always run on roadmap branch:
```bash
# Switch to roadmap
git checkout roadmap
git pull origin roadmap

# View current priorities
project-manager view
```

### For code_developer Daemon

The daemon automatically:
- Syncs with roadmap at start of each iteration
- Updates ROADMAP.md after completing work
- Merges updates back to roadmap immediately
- Ensures roadmap branch stays current
```

### Phase 4: CI/CD Check (30 minutes)

**File**: `.github/workflows/roadmap-sync-check.yml`

```yaml
name: Roadmap Sync Check

on:
  pull_request:
    branches: [main, roadmap]
    paths:
      - 'docs/roadmap/ROADMAP.md'

jobs:
  check-roadmap-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Check if ROADMAP.md on roadmap is newer
        run: |
          # Get last commit date for ROADMAP.md on roadmap branch
          git fetch origin roadmap

          roadmap_date=$(git log origin/roadmap -1 --format=%ct -- docs/roadmap/ROADMAP.md)
          pr_date=$(git log HEAD -1 --format=%ct -- docs/roadmap/ROADMAP.md)

          if [ "$roadmap_date" -gt "$pr_date" ]; then
            echo "⚠️  WARNING: ROADMAP.md on roadmap branch is newer!"
            echo "   The roadmap branch is the single source of truth."
            echo "   Please sync with roadmap branch before merging."
            exit 1
          fi

          echo "✅ ROADMAP.md sync check passed"

      - name: Comment on PR if outdated
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `⚠️ **ROADMAP.md Sync Warning**\n\nThe \`roadmap\` branch has a newer version of ROADMAP.md.\n\nThe roadmap branch is our **single source of truth** for priorities.\n\nPlease sync before merging:\n\`\`\`bash\ngit checkout roadmap\ngit pull origin roadmap\ngit checkout your-branch\ngit merge roadmap\n\`\`\``
            });
```

---

## Benefits

### For Developers
- ✅ **Always know next priority** - Check roadmap branch
- ✅ **No confusion** - Single source of truth
- ✅ **No stale work** - Always synced
- ✅ **Better coordination** - Everyone uses same roadmap

### For code_developer
- ✅ **Reliable priorities** - Always reads latest ROADMAP.md
- ✅ **Automatic sync** - Built into iteration loop
- ✅ **No drift** - Updates pushed immediately
- ✅ **Conflict detection** - Fails fast if sync issues

### For Project Management
- ✅ **Real-time visibility** - Roadmap branch shows current state
- ✅ **Audit trail** - Git history shows all changes
- ✅ **Branch protection** - Can enforce review on roadmap
- ✅ **Clear ownership** - Roadmap branch = authority

---

## Acceptance Criteria

### Must Have
- [ ] code_developer syncs with `origin/roadmap` at start of each iteration
- [ ] code_developer merges ROADMAP.md updates to roadmap immediately
- [ ] project-manager warns if not on roadmap branch
- [ ] Documentation explains roadmap branch as source of truth
- [ ] Feature branches start from roadmap branch (documented)

### Should Have
- [ ] CI check warns if ROADMAP.md on roadmap is newer
- [ ] Daemon logs sync status clearly
- [ ] Conflict handling documented
- [ ] Migration guide for existing workflows

### Nice to Have
- [ ] Automated sync check before daemon starts
- [ ] Branch protection rules on roadmap branch
- [ ] Webhook notification on roadmap updates
- [ ] Dashboard showing roadmap branch status

---

## Migration Plan

### For Existing Work

**Step 1: Ensure roadmap branch is up-to-date**
```bash
# Merge all pending ROADMAP.md changes to roadmap
git checkout roadmap
git pull origin roadmap

# Merge main if needed
git merge main --no-ff -m "Sync main to roadmap"

# Push
git push origin roadmap
```

**Step 2: Update daemon configuration**
```bash
# Deploy new daemon code with sync logic
git checkout roadmap
git pull origin roadmap
poetry install
poetry run code-developer  # Now syncs automatically
```

**Step 3: Notify team**
```markdown
📢 **Important Workflow Change**

The `roadmap` branch is now the **single source of truth** for priorities.

**Action Required**:
1. Always start work from `roadmap` branch
2. Run `project-manager` commands on `roadmap` branch
3. Sync with `roadmap` before creating feature branches

See US-027 for details.
```

---

## Success Metrics

After implementation:
- 100% of daemon iterations start with roadmap sync
- 0% of ROADMAP.md edits on non-roadmap branches
- 100% of developers use roadmap as source of truth
- Roadmap staleness time: <5 minutes (down from hours/days)

---

## Related User Stories
- US-024: Frequent Roadmap Sync (enables this workflow)
- US-021: Code Refactoring (being implemented with this workflow)
- BUG-002: Daemon Roadmap Sync (original sync implementation)

---

## Example Commands

### For Developers Starting New Work

```bash
# CORRECT workflow
git checkout roadmap           # Source of truth
git pull origin roadmap         # Get latest
cat docs/roadmap/ROADMAP.md | grep "📝 Planned"  # Check priorities
git checkout -b feature/us-XXX  # Start from roadmap
```

### For Project Manager Viewing Status

```bash
# CORRECT workflow
git checkout roadmap
git pull origin roadmap
project-manager view  # Shows latest priorities
```

### For code_developer Daemon

```bash
# Automatic behavior (no manual steps needed)
# Daemon syncs with roadmap every iteration
poetry run code-developer  # Just run it!
```

---

## Troubleshooting

### Problem: "My ROADMAP.md is different from roadmap branch"

**Solution**: Sync with roadmap:
```bash
git checkout roadmap
git pull origin roadmap
```

### Problem: "Daemon can't sync - merge conflicts"

**Solution**: Check notification, resolve manually:
```bash
# Daemon created notification
project-manager notifications

# Resolve conflicts
git fetch origin roadmap
git merge origin/roadmap  # See conflicts
# Fix conflicts in docs/roadmap/ROADMAP.md
git add docs/roadmap/ROADMAP.md
git commit -m "Resolve roadmap sync conflicts"
```

### Problem: "I edited ROADMAP.md on feature branch"

**Solution**: Move changes to roadmap branch:
```bash
# Commit your changes
git add docs/roadmap/ROADMAP.md
git commit -m "Update roadmap"

# Switch to roadmap and cherry-pick
git checkout roadmap
git cherry-pick <commit-sha>
git push origin roadmap

# Remove from feature branch if needed
git checkout feature/us-XXX
git revert <commit-sha>
```

---

🤖 **Created**: 2025-10-11 by code_developer (autonomous)
**Estimated Implementation Time**: 2-3 hours
**Priority**: High (critical for workflow clarity and coordination)
