name: ACE Daily Curation

on:
  schedule:
    # Run daily at 2am UTC
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  curate:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Needed to push updated playbooks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history for proper git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Run Reflector
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          poetry run ace-reflector \
            --agent code_developer \
            --hours 24 \
            --verbose
        continue-on-error: true  # Don't fail workflow if no traces found

      - name: Run Curator
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          poetry run ace-curator \
            --agent code_developer \
            --verbose
        continue-on-error: true  # Don't fail workflow if no deltas found

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet docs/curator/playbooks/ docs/reflector/deltas/ 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated playbook
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "ace-bot@monolithiccoffeemaker.com"
          git config --local user.name "ACE Curator Bot"
          git add docs/curator/playbooks/ docs/reflector/deltas/ docs/generator/traces/
          git commit -m "chore: ACE daily curation [skip ci]

          - Updated playbooks from recent execution traces
          - Consolidated insights from last 24 hours
          - Automated curation by GitHub Actions

          Generated by: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}"

      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}

      - name: Summary
        if: always()
        run: |
          echo "## ACE Curation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "docs/curator/playbooks/code_developer_playbook.json" ]; then
            echo "✅ Playbook updated successfully" >> $GITHUB_STEP_SUMMARY

            # Extract some stats (requires jq)
            if command -v jq &> /dev/null; then
              BULLETS=$(jq '.total_bullets' docs/curator/playbooks/code_developer_playbook.json)
              VERSION=$(jq -r '.playbook_version' docs/curator/playbooks/code_developer_playbook.json)
              echo "- Version: $VERSION" >> $GITHUB_STEP_SUMMARY
              echo "- Total bullets: $BULLETS" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ No playbook generated (no traces/deltas found)" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "📝 Changes committed and pushed" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ℹ️ No changes to commit" >> $GITHUB_STEP_SUMMARY
          fi
