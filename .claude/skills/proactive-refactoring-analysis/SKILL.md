# Skill: Proactive Refactoring Analysis

**Version**: 1.0.0
**Status**: Production
**Owner**: architect agent
**Execution Time**: <5 minutes for full codebase
**Schedule**: Weekly (every Monday 9:00 AM)

---

## Overview

The **proactive-refactoring-analysis** skill automatically identifies code health issues and recommends refactoring opportunities with ROI calculations. It helps maintain code quality proactively before issues become blockers.

---

## Features

### 1. Code Complexity Analysis
- Identifies files >500 LOC and >1000 LOC
- Detects functions with cyclomatic complexity >10
- Calculates average complexity and maintainability index
- Uses `radon` library for accurate metrics

### 2. Code Duplication Detection
- Identifies duplicated code patterns across codebase
- Estimates duplication percentage
- Finds common patterns that should be extracted

### 3. Test Coverage Analysis
- Analyzes overall test coverage percentage
- Identifies files with <80% coverage
- Finds untested files
- Uses `pytest-cov` for accurate metrics

### 4. Dependency Analysis
- Detects unused dependencies
- Identifies outdated dependencies
- Finds potential circular dependencies
- Integrates with `poetry` and `autoflake`

### 5. ROI Calculation
- Calculates ROI for each refactoring opportunity
- Categorizes as VERY HIGH / HIGH / MEDIUM / LOW
- Calculates break-even time in months
- Prioritizes recommendations by ROI

### 6. Weekly Report Generation
- Generates comprehensive Markdown reports
- Includes executive summary with health score
- Provides top 3-5 recommendations sorted by ROI
- Saves to `evidence/refactoring-analysis-{timestamp}.md`

### 7. Trend Tracking
- Records metrics week-over-week
- Tracks code health trends over time
- Stores data in `data/refactoring_trends.json`
- Keeps last 12 weeks of history

---

## Usage

### Command Line

```bash
# Run analysis manually
cd /path/to/MonolithicCoffeeMakerAgent
python -m coffee_maker.skills.refactoring_analysis.proactive_refactoring_analysis

# Report saved to: evidence/refactoring-analysis-YYYYMMDD-HHMMSS.md
```

### Python API

```python
from pathlib import Path
from coffee_maker.skills.refactoring_analysis.proactive_refactoring_analysis import main

# Generate report
report = main(codebase_path=Path("/path/to/codebase"))

# Report is returned as markdown string and saved to evidence/
print(report)
```

### Automated (architect agent)

The skill runs automatically every Monday at 9:00 AM via the architect agent's background work loop:

```python
# coffee_maker/autonomous/agents/architect_agent.py

class ArchitectAgent(BaseAgent):
    def _do_background_work(self):
        """Background work includes proactive refactoring analysis."""

        if self._should_run_refactoring_analysis():
            logger.info("🔍 Running proactive refactoring analysis...")
            self._run_refactoring_skill()
```

---

## Report Format

### Executive Summary
- Date and analyzer name
- Overall code health score (0-100)
- Key metrics (complexity, maintainability, coverage, duplication)
- Count of refactoring opportunities

### Top Recommendations (Sorted by ROI)
For each recommendation:
- Title and ROI category
- Issue description
- Effort in hours
- Time saved in hours (future)
- ROI percentage
- Break-even time in months
- Priority level

### Detailed Metrics
- Code complexity metrics
- Code duplication metrics
- Test coverage metrics
- Dependency metrics

### Next Steps
- Actions for project_manager
- Actions for architect
- Actions for code_developer

---

## Example Report

```markdown
# Proactive Refactoring Analysis Report

**Date**: 2025-10-19
**Generated by**: proactive-refactoring-analysis skill
**Codebase**: MonolithicCoffeeMakerAgent

---

## Executive Summary

**Code Health Score**: 72/100

**Key Metrics**:
- Average Complexity: 4.2
- Maintainability Index: 65.3
- Test Coverage: 78.5%
- Code Duplication: 2.3%

**Refactoring Opportunities**: 5

---

## Top Recommendations (Sorted by ROI)

### 1. Extract duplicated pattern (VERY HIGH ROI)

**Issue**: Pattern 'api_key\s*=\s*os\.getenv' duplicated 15 times

**Effort**: 3 hours
**Time Saved**: 15 hours (future)
**ROI**: 400.0%
**Break-even**: 0.2 months
**Priority**: HIGH

---

### 2. Split large file: daemon.py (HIGH ROI)

**Issue**: File has 1806 lines (critical)

**Effort**: 10 hours
**Time Saved**: 20 hours (future)
**ROI**: 100.0%
**Break-even**: 0.5 months
**Priority**: HIGH

---

[... more recommendations ...]
```

---

## Integration with ROADMAP

### Workflow

1. **Generate Report**: Skill runs weekly (Monday 9:00 AM)
2. **architect Reviews**: architect receives report
3. **Send to project_manager**: architect forwards top recommendations
4. **project_manager Prioritizes**: project_manager adds to ROADMAP
5. **Create Specs**: architect creates technical specs
6. **Implement**: code_developer implements refactorings
7. **Track Trends**: Skill tracks improvements week-over-week

### Example ROADMAP Entry

```markdown
### PRIORITY 75: Extract ConfigManager for API Key Loading

**Status**: 📝 Planned

**Priority Level**: ⭐⭐⭐ HIGH

**Estimated Effort**: 3 hours

**From**: proactive-refactoring-analysis report (2025-10-19)

**User Story**:
As a developer, I need centralized API key management, so that I don't have to duplicate key loading logic 15 times across the codebase.

**Business Value**:
- **Time Savings**: 15 hours saved in future API key changes
- **Code Quality**: Single source of truth for configuration
- **Maintainability**: Easier to add fallback logic and error handling
- **ROI**: 400% (3 hours effort, 15 hours saved)

**Acceptance Criteria**:
- [ ] ConfigManager class created in coffee_maker/config/manager.py
- [ ] All 15 instances migrated to use ConfigManager
- [ ] Fallback logic added (env var → .env → config file)
- [ ] Custom exceptions (APIKeyMissingError)
- [ ] Unit tests (95%+ coverage)

**Technical Spec**: Will be created by architect
```

---

## Dependencies

### Required Python Packages

```toml
[tool.poetry.dependencies]
radon = "^6.0.1"          # Code complexity analysis
pytest-cov = "^4.1.0"     # Test coverage analysis
autoflake = "^2.2.1"      # Unused import detection
```

### Required Tools

- `pytest` - Test execution and coverage
- `poetry` - Dependency management
- `grep` - Pattern matching for duplication detection

---

## Configuration

No configuration file needed. The skill uses sensible defaults:

- **Complexity Threshold**: 10 (cyclomatic complexity)
- **File Size Thresholds**: 500 LOC (warning), 1000 LOC (critical)
- **Coverage Target**: 80%
- **Duplication Threshold**: 3 instances
- **Trend History**: 12 weeks
- **Report Location**: `evidence/`
- **Trends Location**: `data/refactoring_trends.json`

---

## Performance

- **Execution Time**: <5 minutes for ~50,000 LOC codebase
- **Memory Usage**: <500 MB
- **CPU Usage**: Low (mostly I/O bound)
- **Disk Usage**: ~10 KB per report
- **Scalability**: Linear with codebase size

**Benchmarks** (MonolithicCoffeeMakerAgent, ~15,000 LOC):
- Code Complexity Analysis: 30 seconds
- Code Duplication Detection: 45 seconds
- Test Coverage Analysis: 180 seconds (includes running tests)
- Dependency Analysis: 30 seconds
- Report Generation: 5 seconds
- **Total**: ~290 seconds (4.8 minutes)

---

## Success Metrics

### Quantitative

| Metric | Target | Measurement |
|--------|--------|-------------|
| **Analysis Time** | <5 min | Timed execution |
| **Reports Generated** | 1 per week | Count in evidence/ |
| **Recommendations Accuracy** | >80% adopted | % added to ROADMAP |
| **Code Health Trend** | Improving | Week-over-week comparison |
| **Test Coverage Trend** | Increasing | Week-over-week comparison |

### Qualitative

- architect receives actionable refactoring suggestions
- project_manager can prioritize refactorings based on ROI
- code_developer has clear implementation targets
- Technical debt trends downward over time

---

## Troubleshooting

### Issue: Analysis times out

**Solution**: Increase timeout in subprocess calls:
```python
result = subprocess.run(..., timeout=600)  # 10 minutes
```

### Issue: pytest-cov not installed

**Solution**: Install dependency:
```bash
poetry add pytest-cov
```

### Issue: No coverage.json file

**Solution**: Ensure pytest-cov is configured:
```bash
pytest --cov=coffee_maker --cov-report=json
```

### Issue: radon import errors

**Solution**: Install radon:
```bash
poetry add radon
```

### Issue: Reports not saved

**Solution**: Check write permissions on `evidence/` directory:
```bash
chmod 755 evidence/
```

---

## Testing

### Unit Tests

```bash
# Run unit tests
pytest tests/unit/skills/refactoring_analysis/ -v

# Run with coverage
pytest tests/unit/skills/refactoring_analysis/ --cov=coffee_maker.skills.refactoring_analysis
```

### Integration Tests

```bash
# Run integration tests
pytest tests/integration/skills/refactoring_analysis/ -v
```

### Manual Testing

```bash
# Generate report manually
python -m coffee_maker.skills.refactoring_analysis.proactive_refactoring_analysis

# Check report
cat evidence/refactoring-analysis-*.md | less
```

---

## Future Enhancements

### Phase 2 (Planned)

1. **Advanced Duplication Detection**
   - Use AST-based duplication detection
   - Detect semantic duplication (not just textual)
   - Integration with `pylint` or `flake8`

2. **Automated Refactoring Suggestions**
   - Generate PR with simple refactorings
   - Extract common patterns automatically
   - Rename variables for clarity

3. **Machine Learning ROI**
   - Learn from historical refactorings
   - Improve time estimates over time
   - Predict which refactorings will be adopted

4. **Interactive Dashboard**
   - Streamlit dashboard for trends
   - Drill-down into specific files
   - Visual trend charts

5. **CI/CD Integration**
   - Run on every PR
   - Block PR if health score drops below threshold
   - Comment on PR with refactoring suggestions

---

## References

- [proactive-refactoring-analysis.md](../proactive-refactoring-analysis.md) - Original skill design
- [radon documentation](https://radon.readthedocs.io/) - Code metrics library
- [pytest-cov documentation](https://pytest-cov.readthedocs.io/) - Coverage tool
- [US-069: ROADMAP](../../../docs/roadmap/ROADMAP.md) - User story

---

## Change Log

### 1.0.0 (2025-10-19)
- Initial implementation
- Code complexity analysis with radon
- Code duplication detection with grep
- Test coverage analysis with pytest-cov
- Dependency analysis with poetry/autoflake
- ROI calculation and prioritization
- Weekly report generation
- Trend tracking (12 weeks)

---

**Remember**: Proactive refactoring prevents technical debt from becoming blocking! 🧹

**Status**: ✅ Production Ready
