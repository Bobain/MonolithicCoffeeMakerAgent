# Workflow and Data Flow Knowledge Base

This document contains the extracted workflow and data flow information from the codebase.
It is used by the workflow-and-data-flow-guide skill to provide orchestration knowledge.

---

## Agent Descriptions and Responsibilities

### project_manager
**Location**: `.claude/agents/project_manager.md`, `docs/AGENT_OWNERSHIP.md`

**Claimed Responsibilities**:
- Parse ROADMAP.md and sync to database
- Create new priorities and user stories
- Monitor GitHub PRs and issues (using `gh` CLI)
- Verify DoD (post-implementation, on user request)
- Create notifications for other agents
- Write strategic documentation in `docs/roadmap/`
- Update `docs/roadmap/PRIORITY_*_STRATEGIC_SPEC.md`

**Database Access**:
- `roadmap_priority`: CREATE, UPDATE (content, status finalization)
- `notifications`: CREATE (outgoing), UPDATE (process incoming)
- `roadmap_audit`: CREATE (automatic on mutations)

**File Ownership**:
- `docs/roadmap/` - Full write access
- `docs/*.md` - Top-level files only
- `docs/templates/` - Documentation templates
- `docs/tutorials/` - Tutorial content

**Forbidden**:
- Code modification (`coffee_maker/`, `tests/`)
- Technical configuration (`.claude/`)
- Architecture docs (`docs/architecture/`)
- Dependency management (`pyproject.toml`)

---

### architect
**Location**: `.claude/agents/architect.md`, `docs/AGENT_OWNERSHIP.md`

**Claimed Responsibilities**:
- Create technical specifications (hierarchical and monolithic)
- Design system architecture before implementation
- Manage dependencies (`pyproject.toml`, `poetry.lock`) - REQUIRES USER APPROVAL
- Link specs to roadmap items (UPDATE `roadmap_priority.spec_id`)
- Document architectural decisions (ADRs)
- Provide implementation guidelines
- Review and improve specs (CFR-010, CFR-011)
- Check code review reports daily using code-review-history skill

**Database Access**:
- `specs_specification`: CREATE, UPDATE (all fields)
- `roadmap_priority`: UPDATE (spec_id linkage ONLY)
- `notifications`: CREATE (outgoing), UPDATE (process incoming)
- `system_audit`: CREATE (automatic)

**File Ownership**:
- `docs/architecture/` - Full write access
- `docs/architecture/specs/` - Technical specifications
- `docs/architecture/decisions/` - ADRs
- `docs/architecture/guidelines/` - Implementation guidelines
- `pyproject.toml` - Dependency management (with user approval)
- `poetry.lock` - Generated by poetry

**Forbidden**:
- Code implementation (`coffee_maker/`, `tests/`)
- Strategic planning (`docs/roadmap/`)
- Technical configuration (`.claude/`)

---

### code_developer
**Location**: `.claude/agents/code_developer.md`, `docs/AGENT_OWNERSHIP.md`

**Claimed Responsibilities**:
- Implement features from technical specs
- Update implementation status (Planned → In Progress → Complete)
- Run tests and create PRs autonomously
- Manage technical configuration (`.claude/`)
- Write ALL code in `coffee_maker/`, `tests/`, `scripts/`
- Update `.claude/CLAUDE.md` (technical setup guide)
- Manage agent configurations (`.claude/agents/`)
- Verify DoD DURING implementation using Puppeteer

**Database Access**:
- `roadmap_priority`: UPDATE (status ONLY)
- `specs_specification`: UPDATE (phase_status, actual_hours)
- `notifications`: CREATE (implementation_complete)
- `roadmap_audit`: CREATE (automatic)

**File Ownership**:
- `coffee_maker/` - All implementation code
- `tests/` - All test code
- `scripts/` - Utility scripts
- `.claude/` - Technical configurations
- `.claude/agents/` - Agent configurations
- `.pre-commit-config.yaml` - Pre-commit hooks

**Forbidden**:
- Strategic planning (`docs/roadmap/`)
- Architecture specs (`docs/architecture/specs/`)
- Dependency decisions (must follow architect's `pyproject.toml`)
- Finalize ROADMAP status (only updates to In Progress/Complete)

---

### code_reviewer
**Location**: `.claude/agents/code_reviewer.md`, `docs/AGENT_OWNERSHIP.md`

**Claimed Responsibilities**:
- Automated code quality checks after commits
- Security scanning
- Style guide enforcement
- Test coverage verification
- Generate review reports in `docs/code-reviews/`
- Notify architect of critical issues
- Run on commit (git hook or polling)

**Database Access**:
- `notifications`: CREATE (review_complete, notify architect)
- No direct database writes

**File Ownership**:
- `docs/code-reviews/` - Review reports

**Forbidden**:
- Code modification
- ROADMAP updates
- Spec creation

---

### orchestrator
**Location**: `.claude/agents/orchestrator.md` (if exists), `coffee_maker/autonomous/orchestrator.py`

**Claimed Responsibilities**:
- Coordinate parallel agent execution
- Manage git worktrees for task isolation
- Monitor task health and progress
- Merge completed work back to `roadmap` branch
- Handle fault tolerance and retries
- Track execution in `orchestrator_tasks` table

**Database Access**:
- `orchestrator_tasks`: CREATE, UPDATE, DELETE
- `roadmap_priority`: SELECT (read for planning)
- `specs_specification`: SELECT (read for task details)

**File Ownership**:
- Git worktrees (temporary, in `/tmp` or similar)
- No permanent file ownership

**Forbidden**:
- Direct code implementation
- Strategic planning
- Spec creation

---

## Complete Workflows

### Workflow: Priority Creation and Implementation

```
[USER] Creates/updates PRIORITY in ROADMAP.md
   ↓
[project_manager] Detects change (file watch or command)
   ↓
[project_manager] Parses ROADMAP.md
   │
   ├─> Extract priority metadata:
   │    - id (e.g., "PRIORITY-25")
   │    - number (e.g., "25")
   │    - title
   │    - status (e.g., "📝 Planned")
   │    - content (full markdown)
   │    - estimated_hours
   │    - dependencies
   │
   └─> Database Operations:
        ├─> INSERT INTO roadmap_priority (
        │     id, item_type, number, title, status,
        │     content, estimated_hours, dependencies,
        │     priority_order, updated_at, updated_by
        │   ) VALUES (..., 'project_manager')
        │
        ├─> INSERT INTO roadmap_audit (
        │     item_id, action, changed_by, changed_at
        │   ) VALUES (id, 'create', 'project_manager', NOW())
        │
        └─> IF spec_id IS NULL:
             INSERT INTO notifications (
               target_agent, source_agent,
               notification_type, item_id,
               message, status, created_at
             ) VALUES (
               'architect', 'project_manager',
               'spec_needed', id,
               'Priority needs technical specification',
               'pending', NOW()
             )
   ↓
[architect] Checks notifications (polling or trigger)
   │
   ├─> Query:
   │    SELECT * FROM notifications
   │    WHERE target_agent='architect'
   │    AND status='pending'
   │    AND notification_type='spec_needed'
   │
   └─> For each notification:
        ├─> Load priority:
        │    SELECT * FROM roadmap_priority WHERE id=item_id
        │
        ├─> Determine spec type (hierarchical or monolithic)
        │
        ├─> Generate spec number:
        │    SELECT MAX(spec_number) FROM specs_specification
        │    spec_number = max + 1
        │
        ├─> Create spec content (using templates)
        │
        ├─> Database Operations:
        │    ├─> INSERT INTO specs_specification (
        │    │     id, spec_number, title, roadmap_item_id,
        │    │     status, spec_type, content, file_path,
        │    │     total_phases, phase_files, estimated_hours,
        │    │     updated_at, updated_by
        │    │   ) VALUES (..., 'architect')
        │    │
        │    ├─> UPDATE roadmap_priority
        │    │    SET spec_id=new_spec_id
        │    │    WHERE id=item_id
        │    │
        │    ├─> UPDATE notifications
        │    │    SET status='processed',
        │    │        processed_at=NOW(),
        │    │        processed_by='architect'
        │    │    WHERE id=notification_id
        │    │
        │    └─> INSERT INTO system_audit (
        │          table_name, item_id, action,
        │          changed_by, changed_at
        │        ) VALUES (
        │          'specs_specification', new_spec_id, 'create',
        │          'architect', NOW()
        │        )
        │
        └─> File Operations (if hierarchical):
             ├─> Create directory:
             │    docs/architecture/specs/SPEC-{number}-{slug}/
             │
             ├─> Write README.md (overview content)
             │
             └─> Write phase files (phase1-*.md, phase2-*.md, ...)
   ↓
[code_developer] Autonomous daemon polling
   │
   ├─> Query for next work:
   │    SELECT * FROM roadmap_priority
   │    WHERE status='📝 Planned'
   │    AND spec_id IS NOT NULL
   │    ORDER BY priority_order ASC
   │    LIMIT 1
   │
   └─> If work found:
        ├─> Load spec:
        │    SELECT * FROM specs_specification WHERE id=spec_id
        │
        ├─> Determine current phase:
        │    - Parse ROADMAP for phase markers
        │    - Check current_phase_status in specs_specification
        │    - Use phase detection logic
        │
        ├─> Update status to In Progress:
        │    UPDATE roadmap_priority
        │    SET status='🔄 In Progress',
        │        implementation_started_at=NOW()
        │    WHERE id=priority_id
        │
        ├─> INSERT INTO roadmap_audit (
        │     item_id, action, field_changed,
        │     old_value, new_value, changed_by, changed_at
        │   ) VALUES (
        │     priority_id, 'status_change', 'status',
        │     'Planned', 'In Progress', 'code_developer', NOW()
        │   )
        │
        ├─> Implement feature:
        │    - Read spec content (README + current phase file)
        │    - Write code in coffee_maker/
        │    - Write tests in tests/
        │    - Run pytest
        │
        ├─> Verify DoD during implementation (Puppeteer MCP)
        │
        ├─> Commit and create PR:
        │    - git add .
        │    - git commit -m "feat: Implement PRIORITY X ..."
        │    - git push origin roadmap
        │    - gh pr create --title "..." --body "..."
        │
        ├─> Update status to Complete:
        │    UPDATE roadmap_priority
        │    SET status='✅ Complete'
        │    WHERE id=priority_id
        │
        ├─> INSERT INTO roadmap_audit (..., action='complete')
        │
        └─> Create notification for project_manager:
             INSERT INTO notifications (
               target_agent, source_agent,
               notification_type, item_id,
               message, status, created_at
             ) VALUES (
               'project_manager', 'code_developer',
               'implementation_complete', priority_id,
               'Feature implemented and PR created',
               'pending', NOW()
             )
   ↓
[code_reviewer] Triggered by commit (git hook or polling)
   │
   ├─> Detect new commits:
   │    git log --since="1 hour ago" --oneline
   │
   ├─> For each commit:
   │    - Run automated checks (black, pytest, security scan)
   │    - Generate review report
   │    - Save to docs/code-reviews/REVIEW-{date}.md
   │
   └─> Notify architect:
        INSERT INTO notifications (
          target_agent, source_agent,
          notification_type, message,
          status, created_at
        ) VALUES (
          'architect', 'code_reviewer',
          'review_complete',
          'Code review report available: {path}',
          'pending', NOW()
        )
   ↓
[project_manager] Responds to notification or user request
   │
   ├─> Query pending notifications:
   │    SELECT * FROM notifications
   │    WHERE target_agent='project_manager'
   │    AND status='pending'
   │
   ├─> Verify DoD with Puppeteer (optional, on user request)
   │
   ├─> Check GitHub PR status:
   │    gh pr view {pr_number}
   │    gh pr checks {pr_number}
   │
   ├─> If all checks pass:
   │    - Mark notification as processed
   │    - Optionally finalize ROADMAP status
   │    - Merge PR: gh pr merge {pr_number}
   │
   └─> UPDATE notifications
        SET status='processed',
            processed_at=NOW(),
            processed_by='project_manager'
```

---

## Database Table Ownership and Operations

### roadmap_priority
**Owner**: project_manager (write), all agents (read)

**Write Operations**:
| Agent | Operations | When |
|-------|-----------|------|
| project_manager | INSERT (create) | On priority creation |
| project_manager | UPDATE (content, status finalization) | On ROADMAP edits, final approval |
| code_developer | UPDATE (status only) | Implementation start/completion |
| architect | UPDATE (spec_id) | After spec creation |

**Read Operations**: All agents (continuous, high frequency)

**Constraints**:
- PRIMARY KEY (id)
- UNIQUE (priority_order)
- FOREIGN KEY (spec_id) REFERENCES specs_specification(id) ON DELETE SET NULL

---

### specs_specification
**Owner**: architect (write), all agents (read)

**Write Operations**:
| Agent | Operations | When |
|-------|-----------|------|
| architect | INSERT (create) | New spec creation |
| architect | UPDATE (all fields) | Spec refinement, phase updates |
| code_developer | UPDATE (current_phase_status, actual_hours) | During implementation |

**Read Operations**:
| Agent | Frequency | Purpose |
|-------|-----------|---------|
| code_developer | High | Load spec for implementation |
| project_manager | Medium | Planning queries |
| architect | Low | Refinement, reviews |

**Constraints**:
- PRIMARY KEY (id)
- UNIQUE (spec_number)
- FOREIGN KEY (roadmap_item_id) REFERENCES roadmap_priority(id)

---

### notifications
**Owner**: All agents (create their own), recipient (processes)

**Write Operations**:
| Agent | Operations | When |
|-------|-----------|------|
| project_manager | INSERT | Request spec, notify completion |
| architect | INSERT | Request review, notify spec ready |
| code_developer | INSERT | Notify implementation complete |
| code_reviewer | INSERT | Notify review complete |
| * | UPDATE | Mark own notifications as processed |

**Read Operations**: Target agent polls for `status='pending'` and `target_agent=self`

**Cleanup**: Periodic job deletes old processed notifications (>30 days)

---

## Event Catalog

### Database Events

| Event | Trigger | Agent | Database Ops |
|-------|---------|-------|--------------|
| `priority_created` | User edits ROADMAP | project_manager | INSERT roadmap_priority, roadmap_audit |
| `priority_status_changed` | Status update | code_developer, project_manager | UPDATE roadmap_priority, INSERT roadmap_audit |
| `spec_created` | Spec creation | architect | INSERT specs_specification, system_audit |
| `spec_linked` | Link spec to priority | architect | UPDATE roadmap_priority.spec_id, INSERT roadmap_audit |
| `implementation_started` | Daemon starts work | code_developer | UPDATE roadmap_priority.status, INSERT roadmap_audit |
| `implementation_complete` | Work finished | code_developer | UPDATE roadmap_priority.status, INSERT roadmap_audit, notifications |
| `notification_created` | Agent creates notification | any | INSERT notifications |
| `notification_processed` | Agent processes notification | recipient | UPDATE notifications |

---

### Git Events

| Event | Trigger | Agent | Operations |
|-------|---------|-------|-----------|
| `commit_created` | Code change | code_developer | git commit |
| `pr_created` | Implementation done | code_developer | gh pr create |
| `pr_merged` | Approval | project_manager | gh pr merge |
| `branch_created` | New feature | code_developer | git branch or git worktree add |
| `worktree_created` | Parallel work | orchestrator | git worktree add |

---

## Orchestration Patterns

### Pattern: Parallel Implementation

```
[orchestrator] Receives list of priorities to implement
   │
   ├─> Query available work:
   │    SELECT * FROM roadmap_priority
   │    WHERE status='📝 Planned'
   │    AND spec_id IS NOT NULL
   │    ORDER BY priority_order
   │
   ├─> Group by dependencies:
   │    - Independent priorities can run in parallel
   │    - Dependent priorities must run sequentially
   │
   └─> For each parallel group:
        ├─> Create isolated worktree:
        │    git worktree add /tmp/worktree-{task_id} \
        │      -b roadmap-implementation_task-{task_id}
        │
        ├─> Track in database:
        │    INSERT INTO orchestrator_tasks (
        │      task_id, roadmap_item_id, worktree_path,
        │      branch_name, status, started_at
        │    ) VALUES (..., 'running', NOW())
        │
        ├─> Launch code_developer in worktree
        │
        ├─> Monitor progress (poll database)
        │
        └─> On completion:
             ├─> UPDATE orchestrator_tasks SET status='complete'
             ├─> Merge to roadmap:
             │    git checkout roadmap
             │    git merge {task-branch}
             ├─> Cleanup:
             │    git worktree remove /tmp/worktree-{task_id}
             │    git branch -D roadmap-implementation_task-{task_id}
             └─> INSERT orchestrator_audit (..., action='task_complete')
```

---

## Design Validation Rules

### Rule 1: Agent Boundary Enforcement
**Check**: Every workflow step must be assigned to a valid agent
**Validation**: Cross-reference with `docs/AGENT_OWNERSHIP.md`
**Violation**: Step assigned to agent without that responsibility

### Rule 2: Database Access Control
**Check**: Agent can only write to authorized tables
**Validation**: Compare proposed writes with ownership matrix
**Violation**: Agent writing to forbidden table

### Rule 3: Audit Trail Required
**Check**: All database mutations must create audit entry
**Validation**: Check for INSERT into `roadmap_audit` or `system_audit`
**Violation**: Mutation without audit

### Rule 4: Data Flow Completeness
**Check**: All data sources and destinations documented
**Validation**: Trace data from input → transformations → output
**Violation**: "Magic" data appearing without source

### Rule 5: Error Handling Defined
**Check**: Error paths documented for each step
**Validation**: Check for rollback, retry, notification strategies
**Violation**: "Happy path only" workflows

### Rule 6: Foreign Key Integrity
**Check**: All foreign key references valid
**Validation**: Check referenced table exists, ON DELETE behavior defined
**Violation**: Orphaned records possible

---

**Version**: 1.0.0
**Last Updated**: 2025-10-25
**Generated From**: Codebase analysis + manual documentation
